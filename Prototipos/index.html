<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prototipo Sistema de Gesti√≥n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      /* Colores principales Universidad de Medell√≠n */
      --udem-rojo: #B71C1C;
      /* Rojo principal UDEM */
      --udem-rojo-hover: #D32F2F;
      /* Rojo hover m√°s claro */
      --udem-rojo-claro: #FFEBEE;
      /* Fondo rojo muy suave */
      --udem-blanco: #FFFFFF;
      /* Blanco oficial */
      --udem-gris-claro: #F5F5F5;
      /* Gris muy claro */
      --udem-gris-medio: #757575;
      /* Gris para textos secundarios */
      --udem-gris-oscuro: #424242;
      /* Gris para textos principales */
      --udem-azul-secundario: #1976D2;
      /* Azul como color de apoyo */
      --udem-azul-hover: #1565C0;
      /* Azul hover */
      --udem-verde-exito: #388E3C;
      /* Verde para √©xito */
      --udem-amarillo: #FFA000;
      /* Amarillo/naranja para advertencias */
    }

    /* Clases Tailwind personalizadas para UDEM */
    .bg-udem-rojo {
      background-color: var(--udem-rojo) !important;
    }

    .bg-udem-rojo-hover:hover {
      background-color: var(--udem-rojo-hover) !important;
    }

    .bg-udem-azul {
      background-color: var(--udem-azul-secundario) !important;
    }

    .bg-udem-azul-hover:hover {
      background-color: var(--udem-azul-hover) !important;
    }

    .text-udem-rojo {
      color: var(--udem-rojo) !important;
    }

    .text-udem-azul {
      color: var(--udem-azul-secundario) !important;
    }

    .bg-udem-verde {
      background-color: var(--udem-verde-exito) !important;
    }

    .bg-udem-verde-hover:hover {
      background-color: #2E7D32 !important;
    }

    .border-udem-rojo {
      border-color: var(--udem-rojo) !important;
    }

    .submenu-btn.active {
      background-color: var(--udem-rojo);
      color: white;
      border-radius: 0.5rem;
      padding: 0.25rem 0.75rem;
    }

    input[type=number] {
      color: #1f2937;
      /* gris oscuro */
    }

    /* Estilos para el Asistente Virtual */
    #chat-window.hidden {
      transform: scale(0);
      opacity: 0;
    }

    .chat-message {
      max-width: 85%;
      padding: 0.75rem;
      border-radius: 1rem;
      margin-bottom: 0.75rem;
      line-height: 1.4;
    }

    .assistant-message {
      background-color: var(--udem-gris-claro);
      color: var(--udem-gris-oscuro);
      border-bottom-left-radius: 0.25rem;
      align-self: flex-start;
    }

    .user-message {
      background-color: var(--udem-azul-secundario);
      color: white;
      border-bottom-right-radius: 0.25rem;
      margin-left: auto;
      /* Alinea a la derecha */
    }

    #chat-body {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <nav class="bg-udem-rojo text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
      <div class="flex items-center space-x-3">
        <img src="escudo.png" alt="UdeM" class="h-10 w-10">
        <span class="font-bold text-lg">Universidad de Medell√≠n</span>
      </div>
  </nav>

  <section id="login" class="min-h-[calc(100vh-4rem)] flex items-center justify-center bg-gradient-to-br from-red-700/10 to-rose-900/10">
    <div class="w-full max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
      <div class="hidden md:flex">
        <div class="relative w-full rounded-2xl overflow-hidden shadow-lg">
          <div class="absolute inset-0 bg-udem-rojo opacity-10"></div>
          <img src="Campus.png" alt="Campus" class="w-full h-full object-cover">
          <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/60 to-transparent text-white">
            <h3 class="text-xl font-semibold">Sistema de Gesti√≥n - L√≠neas de √ânfasis</h3>
            <p class="text-sm text-white/90">Universidad de Medell√≠n</p>
          </div>
        </div>
      </div>
      <div>
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-2xl font-extrabold text-udem-rojo mb-1">Inicio de sesi√≥n</h2>
          <p class="text-gray-700 mb-4">Ingresa tus credenciales y selecciona tu rol para iniciar sesi√≥n.</p>
          <div class="mb-4">
            <div class="mb-4">
            <label for="rolSeleccionado" class="block text-sm text-gray-600 font-medium mb-1">Rol seleccionado:</label>
            <select id="rolSeleccionado" name="rol" class="ml-2 inline-flex items-center px-3 py-2 rounded-lg bg-udem-rojo text-white text-sm focus:ring-2 focus:ring-udem-azul focus:outline-none">
                <option data-role="estudiante" selected>Estudiante</option>
                <option data-role="profesor">Profesor</option>
                <option data-role="coordinador">Coordinador</option>
            </select>
            </div>
          </div>
          <form id="loginForm" class="space-y-4" autocomplete="on" novalidate>
            <div>
              <label for="nombreUsuario" class="block text-sm text-gray-800 font-medium mb-1">Usuario / C√≥digo</label>
              <input id="nombreUsuario" name="usuario" type="text" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-udem-azul focus:outline-none" placeholder="p.ej. 202512345 o jperez">
            </div>
            <div>
              <div>
              <label for="password" class="block text-sm text-gray-800 font-medium mb-1">Contrase√±a</label>
              <div class="flex items-center border rounded-lg px-3">
                <input id="password" name="password" type="password" required class="flex-1 py-2 focus:outline-none" placeholder="********">
                <button type="button" id="btnTogglePass" class="text-gray-500 ml-2" aria-label="Mostrar/Ocultar contrase√±a">üëÅÔ∏è</button>
              </div>
            </div>
            <label class="mt-1 flex items-center space-x-2">
              <input id="chkRobot" type="checkbox" class="accent-red-700">
              <span class="text-sm text-gray-800">No soy un robot</span>
            </label>
            <div id="loginError" class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-2"></div>
            <button type="submit" class="w-full bg-udem-rojo text-white py-2.5 rounded-lg hover:bg-udem-rojo-hover font-semibold">
              Iniciar sesi√≥n
            </button>
            <div class="flex items-center justify-between text-sm">
              <button type="button" class="text-gray-500 hover:underline" onclick="document.getElementById('loginForm').reset()">Limpiar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <section id="dashboard-estudiante" class="hidden min-h-screen bg-gray-50">
    <header class="bg-udem-rojo shadow p-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <img src="escudo.png" alt="UdeM" class="h-10 w-10">
        <h1 class="text-xl font-bold text-white">Panel Estudiante</h1>
      </div>
      <div class="flex items-center space-x-4">
        <span id="nombre-display-estudiante" class="text-white"></span>
        <img id="avatar-display-estudiante" src="" class="w-10 h-10 rounded-full border-2 border-white" alt="Avatar">
        <button onclick="cerrarSesion()" class="bg-white text-udem-rojo px-3 py-1 rounded-lg hover:bg-gray-100" title="Salir del sistema">Cerrar sesion</button>
      </div>
    </header>

    <main class="p-6 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
      <aside class="lg:col-span-3 space-y-6">
        <div class="bg-white p-4 rounded-2xl shadow sticky top-24">
          <h2 class="text-lg font-semibold text-udem-azul mb-3">üìÖ Calendario</h2>
          <div id="calendario" class="grid grid-cols-7 gap-2 text-sm"></div>
        </div>
      </aside>

      <div class="lg:col-span-6 space-y-10">

        <section class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-2xl font-bold text-udem-azul mb-2">Bienvenido a tu panel</h2>
          <p class="text-gray-600">Aqu√≠ podr√°s gestionar tus inscripciones y estar al tanto de tus notificaciones.</p>
        </section>

        <section class="bg-white p-6 rounded-2xl shadow space-y-6">
          <h2 class="text-xl font-semibold text-udem-azul">B√∫squeda de L√≠neas de √ânfasis</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label for="filtro-carrera" class="block text-sm text-gray-600 mb-1">Carrera</label>
              <select id="filtro-carrera" class="w-full border rounded-lg px-3 py-2">
                <option value="Todas">Todas</option>
                <option value="Ingenier√≠a de Sistemas">Ingenier√≠a de Sistemas</option>
                <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                <option value="Matem√°ticas">Matem√°ticas</option>
              </select>
            </div>
            <button type="button" onclick="resetFiltroCarrera()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg" title="Limpiar todos los filtros de busqueda">Limpiar Filtros</button>
          </div>

          <div id="lista-lineas" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="linea-card bg-gradient-to-br from-white to-blue-50 p-6 rounded-2xl shadow hover:shadow-lg transition-shadow" data-carrera="Ingenier√≠a de Sistemas">
              <h3 class="text-lg font-semibold text-gray-700">Seguridad Inform√°tica</h3>
              <p class="text-gray-500">Cupos: <span class="text-blue-600 font-semibold">15/25</span></p>
              <p class="text-gray-500">Prerrequisitos: Redes de Computadores</p>
              <p class="text-sm text-gray-400 mt-2">Modalidad: Presencial | Duraci√≥n: 16 semanas</p>
              <div class="mt-4 flex flex-wrap gap-2">
                <button onclick="verDetallesLinea('seguridad-informatica')" class="bg-udem-azul text-white px-4 py-2 rounded-lg hover:bg-udem-azul-hover transition-colors" title="Ver informaci√≥n completa de la l√≠nea, cronograma y requisitos">
                  Ver Detalles
                </button>
                <button onclick="openSolicitudModal('Seguridad Inform√°tica')" class="bg-udem-rojo text-white px-4 py-2 rounded-lg hover:bg-udem-rojo-hover transition-colors" title="Iniciar proceso de inscripci√≥n a esta l√≠nea de √©nfasis">
                  Solicitar
                </button>
              </div>
            </div>

            <div class="linea-card bg-gradient-to-br from-white to-green-50 p-6 rounded-2xl shadow hover:shadow-lg transition-shadow" data-carrera="Ingenier√≠a de Sistemas">
              <h3 class="text-lg font-semibold text-gray-700">Inteligencia Artificial</h3>
              <p class="text-gray-500">Cupos: <span class="text-orange-600 font-semibold">18/20</span></p>
              <p class="text-gray-500">Prerrequisitos: Algoritmos Avanzados, Matem√°ticas III</p>
              <p class="text-sm text-gray-400 mt-2">Modalidad: H√≠brida | Duraci√≥n: 16 semanas</p>
              <div class="mt-4 flex flex-wrap gap-2">
                <button onclick="verDetallesLinea('inteligencia-artificial')" class="bg-udem-azul text-white px-4 py-2 rounded-lg hover:bg-udem-azul-hover transition-colors" title="Ver informaci√≥n completa de la l√≠nea, cronograma y requisitos">
                  Ver Detalles
                </button>
                <button onclick="openSolicitudModal('Inteligencia Artificial')" class="bg-udem-rojo text-white px-4 py-2 rounded-lg hover:bg-udem-rojo-hover transition-colors" title="Iniciar proceso de inscripci√≥n a esta l√≠nea de √©nfasis">
                  Solicitar
                </button>
              </div>
            </div>

            <div class="linea-card bg-gradient-to-br from-white to-purple-50 p-6 rounded-2xl shadow hover:shadow-lg transition-shadow" data-carrera="Ingenier√≠a Industrial">
              <h3 class="text-lg font-semibold text-gray-700">Gesti√≥n de Calidad</h3>
              <p class="text-gray-500">Cupos: <span class="text-green-600 font-semibold">12/18</span></p>
              <p class="text-gray-500">Prerrequisitos: Estad√≠stica II, Control de Procesos</p>
              <p class="text-sm text-gray-400 mt-2">Modalidad: Presencial | Duraci√≥n: 16 semanas</p>
              <div class="mt-4 flex flex-wrap gap-2">
                <button onclick="verDetallesLinea('gestion-calidad')" class="bg-udem-azul text-white px-4 py-2 rounded-lg hover:bg-udem-azul-hover transition-colors" title="Ver informaci√≥n completa de la l√≠nea, cronograma y requisitos">
                  Ver Detalles
                </button>
                <button onclick="openSolicitudModal('Gesti√≥n de Calidad')" class="bg-udem-rojo text-white px-4 py-2 rounded-lg hover:bg-udem-rojo-hover transition-colors" title="Iniciar proceso de inscripci√≥n a esta l√≠nea de √©nfasis">
                  Solicitar
                </button>
              </div>
            </div>

            <div class="linea-card bg-gradient-to-br from-white to-yellow-50 p-6 rounded-2xl shadow hover:shadow-lg transition-shadow" data-carrera="Matem√°ticas">
              <h3 class="text-lg font-semibold text-gray-700">An√°lisis de Datos</h3>
              <p class="text-gray-500">Cupos: <span class="text-red-600 font-semibold">19/20</span></p>
              <p class="text-gray-500">Prerrequisitos: C√°lculo III, Probabilidad</p>
              <p class="text-sm text-gray-400 mt-2">Modalidad: Virtual | Duraci√≥n: 16 semanas</p>
              <div class="mt-4 flex flex-wrap gap-2">
                <button onclick="verDetallesLinea('analisis-datos')" class="bg-udem-azul text-white px-4 py-2 rounded-lg hover:bg-udem-azul-hover transition-colors" title="Ver informaci√≥n completa de la l√≠nea, cronograma y requisitos">
                  Ver Detalles
                </button>
                <button onclick="openSolicitudModal('An√°lisis de Datos')" class="bg-udem-rojo text-white px-4 py-2 rounded-lg hover:bg-udem-rojo-hover transition-colors" title="Iniciar proceso de inscripci√≥n a esta l√≠nea de √©nfasis">
                  Solicitar
                </button>
              </div>
            </div>
          </div>

        </section>
        <section class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-xl font-semibold text-udem-azul mb-4">Mis Solicitudes</h2>
          <div class="overflow-x-auto">
            <table class="w-full rounded-2xl shadow overflow-hidden">
              <thead class="bg-udem-rojo text-white">
                <tr>
                  <th class="p-3 text-left">L√≠nea</th>
                  <th class="p-3 text-left">Programa</th>
                  <th class="p-3 text-left">Fecha</th>
                  <th class="p-3 text-left">Estado</th>
                  <th class="p-3 text-left">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="solicitudes-tbody" class="text-gray-700">
                </tbody>
            </table>
          </div>
        </section>
      </div>
      <aside class="lg:col-span-3 space-y-6">
        <div class="bg-white p-4 rounded-2xl shadow sticky top-24">
          <h2 class="text-lg font-semibold text-udem-azul mb-3">üîî Notificaciones</h2>
          <ul id="lista-notificaciones" class="text-gray-700 space-y-2 text-sm">
            <li class="bg-gray-50 p-2 rounded">üì¢ Aprobaci√≥n de l√≠nea en espera</li>
            <li class="bg-gray-50 p-2 rounded">üì¢ Nuevo cronograma disponible</li>
          </ul>
        </div>
      </aside>
    </main>
  </section>

  <div id="modal-solicitud" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60" onclick="closeSolicitudModal()"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6 z-10 mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 class="text-xl font-semibold">Solicitar Inscripci√≥n</h3>
          <p class="text-sm text-gray-600">L√≠nea:
            <span id="modal-linea-name" class="font-medium text-udem-azul"></span>
          </p>
        </div>
        <button onclick="closeSolicitudModal()" class="text-gray-400 hover:text-gray-600 text-xl" title="Cerrar formulario de solicitud">‚úï</button>
      </div>
      <form id="solicitudForm" class="space-y-6">
        <input type="hidden" id="modal-linea">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="font-semibold text-gray-700 mb-3">üë§ Informaci√≥n Personal</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Nombre completo *</label>
              <input id="solicitud-nombre" type="text" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">C√©dula *</label>
              <input id="solicitud-cedula" type="text" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Correo institucional *</label>
              <input id="solicitud-email" type="email" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Tel√©fono</label>
              <input id="solicitud-telefono" type="tel" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none">
            </div>
          </div>
        </div>
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="font-semibold text-gray-700 mb-3">üéì Informaci√≥n Acad√©mica</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Programa actual *</label>
              <select id="solicitud-programa" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
                <option value="">Seleccionar programa</option>
                <option value="Ingenier√≠a de Sistemas">Ingenier√≠a de Sistemas</option>
                <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                <option value="Dise√±o Gr√°fico">Dise√±o Gr√°fico</option>
                <option value="Matem√°ticas">Matem√°ticas</option>
                <option value="Administraci√≥n">Administraci√≥n</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Semestre actual *</label>
              <select id="solicitud-semestre" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
                <option value="">Seleccionar</option>
                <option value="6">6to semestre</option>
                <option value="7">7mo semestre</option>
                <option value="8">8vo semestre</option>
                <option value="9">9no semestre</option>
                <option value="10">10mo semestre</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Promedio acumulado *</label>
              <input id="solicitud-promedio" type="number" step="0.1" min="0" max="5" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">C√≥digo estudiantil *</label>
              <input id="solicitud-codigo" type="text" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
            </div>
          </div>
        </div>
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
          <h4 class="font-semibold text-gray-700 mb-3">üìé Archivos Requeridos</h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-600 mb-2">Certificado de notas actualizado *</label>
              <input type="file" id="archivo-notas" accept=".pdf,.jpg,.jpeg,.png" class="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
              <p class="text-xs text-gray-500 mt-1">Formatos: PDF, JPG, PNG (m√°x. 5MB)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-2">Carta de motivaci√≥n *</label>
              <input type="file" id="archivo-motivacion" accept=".pdf,.doc,.docx" class="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-udem-azul focus:outline-none" required>
              <p class="text-xs text-gray-500 mt-1">Formatos: PDF, Word (m√°x. 2MB)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-2">Certificados de prerrequisitos</label>
              <input type="file" id="archivo-prerrequisitos" accept=".pdf,.jpg,.jpeg,.png" multiple class="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-udem-azul focus:outline-none">
              <p class="text-xs text-gray-500 mt-1">Opcional. Puedes seleccionar m√∫ltiples archivos</p>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-2">Otros documentos de apoyo</label>
              <input type="file" id="archivo-otros" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple class="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-udem-azul focus:outline-none">
              <p class="text-xs text-gray-500 mt-1">Opcional. Certificaciones, reconocimientos, etc.</p>
            </div>
          </div>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <label class="flex items-start space-x-2">
            <input id="declaracion-veracidad" type="checkbox" class="mt-1 accent-udem-rojo" required>
            <span class="text-sm text-gray-700">
              Declaro que toda la informaci√≥n proporcionada es veraz y los documentos adjuntos son aut√©nticos.
              Entiendo que informaci√≥n falsa puede resultar en la cancelaci√≥n de mi solicitud.
            </span>
          </label>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t">
          <button type="button" onclick="closeSolicitudModal()" class="px-6 py-2 rounded-lg border hover:bg-gray-50 transition-colors" title="Cancelar y cerrar formulario">
            Cancelar
          </button>
          <button type="submit" class="px-6 py-2 rounded-lg bg-udem-rojo text-white hover:bg-udem-rojo-hover transition-colors font-semibold" title="Enviar solicitud de inscripci√≥n">
            üì§ Enviar Solicitud
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-detalles-linea" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60" onclick="closeDetallesModal()"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto z-10">
      <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
        <div>
          <h3 id="modal-titulo-linea" class="text-2xl font-bold text-udem-azul">L√≠nea de √ânfasis</h3>
          <p id="modal-programa-linea" class="text-gray-600">Programa acad√©mico</p>
        </div>
        <button onclick="closeDetallesModal()" class="text-gray-400 hover:text-gray-600 text-2xl" title="Cerrar ventana de detalles">
          ‚úï
        </button>
      </div>
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold text-gray-700 mb-2">üìä Disponibilidad</h4>
              <div class="space-y-2">
                <p><span class="font-medium">Cupos disponibles:</span> <span id="modal-cupos" class="text-blue-600 font-semibold">15/25</span></p>
                <p><span class="font-medium">Modalidad:</span> <span id="modal-modalidad">Presencial</span></p>
                <p><span class="font-medium">Duraci√≥n:</span> <span id="modal-duracion">16 semanas</span></p>
                <p><span class="font-medium">Inicio de clases:</span> <span id="modal-inicio">15 de Agosto 2025</span></p>
              </div>
            </div>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
              <h4 class="font-semibold text-gray-700 mb-2">‚ö†Ô∏è Prerrequisitos</h4>
              <ul id="modal-prerrequisitos" class="space-y-1 text-sm">
                <li>‚Ä¢ Redes de Computadores</li>
                <li>‚Ä¢ Promedio m√≠nimo: 3.5</li>
              </ul>
            </div>
          </div>
          <div class="space-y-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <h4 class="font-semibold text-gray-700 mb-2">üéì Informaci√≥n Acad√©mica</h4>
              <div class="space-y-2 text-sm">
                <p><span class="font-medium">Cr√©ditos:</span> <span id="modal-creditos">6</span></p>
                <p><span class="font-medium">Profesor:</span> <span id="modal-profesor">Dr. Juan Mart√≠nez</span></p>
                <p><span class="font-medium">Horario:</span> <span id="modal-horario">Lun-Mi√© 2:00-4:00 PM</span></p>
                <p><span class="font-medium">Aula:</span> <span id="modal-aula">Lab. Sistemas 302</span></p>
              </div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <h4 class="font-semibold text-gray-700 mb-2">üèÜ Competencias</h4>
              <ul id="modal-competencias" class="space-y-1 text-sm">
                <li>‚Ä¢ An√°lisis de vulnerabilidades</li>
                <li>‚Ä¢ Implementaci√≥n de controles</li>
                <li>‚Ä¢ Auditor√≠a de sistemas</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 p-6 rounded-lg">
          <h4 class="font-semibold text-gray-700 mb-3">üìù Descripci√≥n del Programa</h4>
          <p id="modal-descripcion" class="text-gray-600 leading-relaxed">
            Esta l√≠nea de √©nfasis se enfoca en formar profesionales capaces de identificar, evaluar y mitigar riesgos de seguridad en sistemas de informaci√≥n. Los estudiantes desarrollar√°n competencias en criptograf√≠a, an√°lisis forense digital, y gesti√≥n de incidentes de seguridad.
          </p>
        </div>
        <div class="bg-white border rounded-lg overflow-hidden">
          <div class="bg-udem-azul text-white p-4">
            <h4 class="font-semibold">üìÖ Cronograma General</h4>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-3">
                <h5 class="font-semibold text-gray-700">Primer Periodo</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between border-b pb-1">
                    <span>Semanas 1-4</span>
                    <span class="text-gray-600">Fundamentos</span>
                  </div>
                  <div class="flex justify-between border-b pb-1">
                    <span>Semanas 5-8</span>
                    <span class="text-gray-600">Criptograf√≠a</span>
                  </div>
                </div>
              </div>
              <div class="space-y-3">
                <h5 class="font-semibold text-gray-700">Segundo Periodo</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between border-b pb-1">
                    <span>Semanas 9-12</span>
                    <span class="text-gray-600">An√°lisis Forense</span>
                  </div>
                  <div class="flex justify-between border-b pb-1">
                    <span>Semanas 13-16</span>
                    <span class="text-gray-600">Proyecto Final</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-purple-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-700 mb-3">üõ†Ô∏è Herramientas</h4>
            <ul id="modal-herramientas" class="space-y-1 text-sm">
              <li>‚Ä¢ Kali Linux</li>
              <li>‚Ä¢ Wireshark</li>
              <li>‚Ä¢ Metasploit</li>
              <li>‚Ä¢ OWASP ZAP</li>
            </ul>
          </div>
          <div class="bg-orange-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-700 mb-3">üìö Recursos</h4>
            <ul class="space-y-1 text-sm">
              <li>‚Ä¢ Laboratorio especializado</li>
              <li>‚Ä¢ Biblioteca digital</li>
              <li>‚Ä¢ Simuladores en l√≠nea</li>
              <li>‚Ä¢ Acceso a bases de datos</li>
            </ul>
          </div>
        </div>
        <<div class="flex flex-wrap gap-3 pt-4 border-t">
        <button onclick="closeDetallesModal()" class="border border-gray-300 px-6 py-2 rounded-lg hover:bg-gray-50">
            Cerrar
        </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== SECCI√ìN DEL PROFESOR ==================== -->

<section id="dashboard-profesor" class="hidden min-h-screen bg-gray-50">
  <!-- HEADER -->
  <header class="bg-udem-rojo shadow p-4 flex justify-between items-center">
    <div class="flex items-center space-x-3">
      <img src="escudo.png" alt="UdeM" class="h-10 w-10">
      <h1 class="text-xl font-bold text-white">Panel Profesor</h1>
    </div>
    <div class="flex items-center space-x-4">
      <span id="nombre-display-profesor" class="text-white"></span>
      <img id="avatar-display-profesor" src="" class="w-10 h-10 rounded-full border-2 border-white" alt="Avatar">
      <button onclick="cerrarSesion()" class="bg-white text-udem-rojo px-3 py-1 rounded-lg hover:bg-gray-100">
        Cerrar Sesi√≥n
      </button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="p-6 max-w-7xl mx-auto">
    
    <!-- ESTAD√çSTICAS R√ÅPIDAS -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-500">
        <div class="text-gray-500 text-sm">Cursos Activos</div>
        <div class="text-2xl font-bold text-gray-800" id="stat-cursos">3</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-green-500">
        <div class="text-gray-500 text-sm">Total Estudiantes</div>
        <div class="text-2xl font-bold text-gray-800" id="stat-estudiantes">68</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-yellow-500">
        <div class="text-gray-500 text-sm">Evaluaciones Pendientes</div>
        <div class="text-2xl font-bold text-gray-800" id="stat-pendientes">5</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-red-500">
        <div class="text-gray-500 text-sm">Pr√≥xima Clase</div>
        <div class="text-sm font-bold text-gray-800" id="stat-proxima">Hoy 2:00 PM</div>
      </div>
    </div>

    <!-- NAVEGACI√ìN POR PESTA√ëAS -->
    <div class="bg-white rounded-xl shadow-md mb-6">
      <div class="border-b border-gray-200">
        <nav class="flex space-x-4 px-6">
          <button onclick="cambiarTab('cursos')" id="tab-cursos" 
                    class="tab-btn py-4 px-4 font-medium border-b-2 border-udem-rojo text-udem-rojo"> 
            üìö Mis Cursos 
          </button>
          <button onclick="cambiarTab('calendario')" id="tab-calendario" 
                  class="tab-btn py-4 px-4 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            üìÖ Calendario
          </button>
        </nav>
      </div>

      <!-- CONTENIDO DE PESTA√ëAS -->
      <div class="p-6">
        
        <!-- TAB: MIS CURSOS -->
        <div id="content-cursos" class="tab-content">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Cursos Asignados - Semestre 2025-1</h2>
            <span class="text-sm text-gray-500">üìö Total: <strong id="total-cursos-count">0</strong> cursos</span>
          </div>
          <div id="lista-cursos" class="space-y-4">
            <!-- Los cursos se cargar√°n aqu√≠ din√°micamente -->
          </div>
        </div>

        <!-- TAB: CALENDARIO -->
        <div id="content-calendario" class="tab-content hidden">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Calendario de Clases</h2>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <p class="text-gray-600 mb-4">üóìÔ∏è Pr√≥ximas clases programadas:</p>
            <div id="calendario-lista" class="space-y-3">
              <!-- Se llenar√° din√°micamente -->
            </div>
          </div>
        </div>

  </main>
</section>

  <!-- ==================== MODAL DE GESTI√ìN DE NOTAS ==================== -->

<div id="modal-gestion-notas" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/60" onclick="closeGestionNotas()"></div>
  <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto z-10 mx-4">
    
    <!-- HEADER DEL MODAL -->
    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center z-20">
      <div>
        <h3 id="titulo-curso-notas" class="text-xl font-bold text-gray-800">Gesti√≥n de Notas</h3>
        <p class="text-sm text-gray-500" id="info-curso-notas">Curso: [Nombre del curso]</p>
      </div>
      <button onclick="closeGestionNotas()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
    </div>

    <!-- TOOLBAR -->
    <div class="p-4 bg-gray-50 border-b">
      <div class="flex flex-wrap gap-3 items-center justify-between">
        <div class="flex gap-3">
          <button onclick="agregarEvaluacion()" class="bg-udem-azul text-white px-4 py-2 rounded-lg hover:bg-udem-azul-hover transition-colors flex items-center gap-2">
            <span>‚ûï</span> Nueva Evaluaci√≥n
          </button>
          <button onclick="guardarCambios()" class="bg-udem-rojo text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-colors flex items-center gap-2">
            <span>üíæ</span> Guardar Cambios
          </button>
        </div>
        <div class="flex items-center gap-3">
          <div id="porcentaje-restante" class="text-sm font-medium px-3 py-2 rounded-lg bg-yellow-100 text-yellow-800">
            ‚ö†Ô∏è Configurar porcentajes
          </div>
          <button id="btn-generar-reporte" onclick="generarReporteCurso()" 
                  class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2" 
                  disabled>
            <span>üì§</span> Generar Reporte
          </button>
        </div>
      </div>
    </div>

    <!-- TABLA DE NOTAS -->
    <div class="p-4">
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse" id="tabla-notas">
          <thead class="bg-udem-azul text-white">
            <tr id="thead-notas">
              <th class="p-3 border text-left sticky left-0 bg-udem-azul z-10">Estudiante</th>
              <th class="p-3 border text-left">C√≥digo</th>
              <th class="p-3 border text-center bg-udem-rojo">Nota Final</th>
            </tr>
          </thead>
          <tbody id="tbody-notas" class="bg-white">
          </tbody>
        </table>
      </div>
      <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-gray-700">
          <strong>üí° Instrucciones:</strong>
        </p>
        <ul class="text-sm text-gray-600 mt-2 space-y-1 list-disc list-inside">
          <li>Puedes guardar cambios aunque la suma de porcentajes no sea 100%</li>
          <li>Solo podr√°s generar el reporte final cuando la suma sea exactamente 100%</li>
          <li>Haz clic en los campos para editar nombres, porcentajes y notas</li>
          <li>Usa el bot√≥n "üóëÔ∏è" en cada evaluaci√≥n para eliminarla</li>
        </ul>
      </div>
    </div>

  </div>
</div>
<!-- ==================== MODAL DE GESTI√ìN DE ASISTENCIAS ==================== -->

<div id="modal-gestion-asistencias" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/60" onclick="closeGestionAsistencias()"></div>
  <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto z-10 mx-4">
    
    <!-- HEADER -->
    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center z-20">
      <div>
        <h3 id="titulo-curso-asistencias" class="text-xl font-bold text-gray-800">Gesti√≥n de Asistencias</h3>
        <p class="text-sm text-gray-500" id="info-curso-asistencias">Curso: [Nombre del curso]</p>
      </div>
      <button onclick="closeGestionAsistencias()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
    </div>

    <!-- TOOLBAR -->
    <div class="p-4 bg-gray-50 border-b">
      <div class="flex flex-wrap gap-3 items-center justify-between">
        <div class="flex gap-3 items-center">
          <label class="text-sm font-medium text-gray-700">Fecha:</label>
          <input type="date" id="fecha-asistencia" class="border rounded px-3 py-2 text-sm" />
          <button onclick="cargarAsistenciaFecha()" class="bg-udem-azul text-white px-4 py-2 rounded-lg hover:bg-udem-azul-hover">
            üìÖ Cargar
          </button>
        </div>
        <div class="flex gap-3">
          <button onclick="guardarAsistencias()" class="bg-udem-rojo text-white px-4 py-2 rounded-lg hover:bg-opacity-90">
            üíæ Guardar Asistencias
          </button>
          <button onclick="generarReporteAsistencias()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
            üìä Generar Reporte
          </button>
        </div>
      </div>
    </div>

    <!-- TABLA -->
    <div class="p-4">
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse">
          <thead class="bg-udem-azul text-white">
            <tr>
              <th class="p-3 border text-left">Estudiante</th>
              <th class="p-3 border text-left">C√≥digo</th>
              <th class="p-3 border text-center">Presente</th>
              <th class="p-3 border text-center">% Asistencia</th>
              <th class="p-3 border text-left">Observaciones</th>
            </tr>
          </thead>
          <tbody id="tbody-asistencias" class="bg-white">
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

  <section id="dashboard-coordinador" class="hidden min-h-screen bg-gray-50">
    <header class="bg-udem-rojo shadow p-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <img src="escudo.png" alt="UdeM" class="h-10 w-10">
        <h1 class="text-xl font-bold text-white">Panel Coordinador</h1>
      </div>
      <div class="flex items-center space-x-4">
        <span id="nombre-display-coordinador" class="text-white"></span>
        <img id="avatar-display-coordinador" src="" class="w-10 h-10 rounded-full border-2 border-white" alt="Avatar">
        <button onclick="cerrarSesion()" class="bg-white text-udem-rojo px-3 py-1 rounded-lg hover:bg-gray-100" title="Salir del sistema">Cerrar Sesion</button>
      </div>
    </header>
    <main class="p-6 max-w-7xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-xl font-semibold text-udem-azul mb-4">Estad√≠sticas</h2>
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span>Solicitudes pendientes</span>
              <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm">23</span>
            </div>
            <div class="flex justify-between items-center">
              <span>L√≠neas activas</span>
              <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">8</span>
            </div>
            <div class="flex justify-between items-center">
              <span>Estudiantes inscritos</span>
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">156</span>
            </div>
          </div>
        </div>
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow">
          <h2 class="text-xl font-semibold text-udem-azul mb-4">Solicitudes Recientes</h2>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left text-sm font-medium text-gray-600">Estudiante</th>
                  <th class="p-3 text-left text-sm font-medium text-gray-600">L√≠nea</th>
                  <th class="p-3 text-left text-sm font-medium text-gray-600">Estado</th>
                  <th class="p-3 text-left text-sm font-medium text-gray-600">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="tbody-solicitudes-coordinador" class="text-sm">
                <!-- Las solicitudes se cargar√°n din√°micamente aqu√≠ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <section id="gestion-lineas" class="p-6 bg-white rounded-2xl shadow mt-6">
        <h2 class="text-xl font-bold text-udem-azul mb-4">Gesti√≥n de L√≠neas de √ânfasis</h2>
        <form onsubmit="agregarLinea(event)" class="flex gap-3 mb-4">
          <input id="nueva-linea" placeholder="Nombre de l√≠nea" class="flex-1 border px-3 py-2 rounded">
          <button class="bg-udem-rojo text-white px-4 py-2 rounded">Agregar</button>
        </form>
        <ul id="lista-lineas-admin" class="space-y-2"></ul>
      </section>
    </main>
  </section>

  <div id="modal-solicitud-detalle" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60" onclick="closeSolicitudDetalle()"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6 z-10 mx-4 max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-semibold mb-4">Solicitud Estudiante</h3>
      <div id="detalle-solicitud"></div>
      <div class="flex justify-end gap-3 mt-4">
        <button onclick="aprobarSolicitud()" class="bg-green-600 text-white px-4 py-2 rounded">‚úÖ Aprobar</button>
        <button onclick="rechazarSolicitud()" class="bg-red-600 text-white px-4 py-2 rounded">‚ùå Rechazar</button>
      </div>
    </div>
  </div>
<!-- Firebase SDK (versi√≥n compatible) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- Configuraci√≥n de Firebase -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDl5z3iUtGLLRShlX5pp7yit8ajJQQ700Y",
    authDomain: "udem-sistema.firebaseapp.com",
    databaseURL: "https://udem-sistema-default-rtdb.firebaseio.com",
    projectId: "udem-sistema",
    storageBucket: "udem-sistema.firebasestorage.app",
    messagingSenderId: "667104791773",
    appId: "1:667104791773:web:7ebeba8da75d2f73649f34"
  };
  
  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  window.firebaseDB = firebase.database();
  console.log('‚úÖ Firebase conectado');
</script>

<!-- Cargar base de datos -->
<script src="database.js"></script>
<script>
    
    // ------------------- Utilidades UI -------------------
    const roleButtons = () => document.querySelectorAll('[data-role]');
    // ------------------- Variables Globales -------------------
    let selectedRole = 'estudiante';
    let currentLineaDetails = null;

    function setRole(role) {
      selectedRole = role;
      roleButtons().forEach(btn => {
        const isActive = btn.dataset.role === role;
        btn.classList.toggle('bg-white', isActive);
        btn.classList.toggle('text-udem-rojo', isActive);
        btn.classList.toggle('font-semibold', isActive);
      });
      const chip = document.getElementById('chip-rol');
      if (chip) {
        const label = role.charAt(0).toUpperCase() + role.slice(1);
        chip.textContent = label;
      }
    }
    // ------------------- Navegaci√≥n SPA -------------------
    function mostrarSeccion(id) {
      document.querySelectorAll('body > section').forEach(sec => sec.classList.add('hidden'));
      const target = document.getElementById(id);
      if (target) {
        target.classList.remove('hidden');
        window.scrollTo({
          top: 0,
          behavior: 'instant'
        });
      }
      const nav = document.querySelector("nav");
      if (nav) {
        nav.classList.toggle("hidden", id !== "login");
      }
      
      // NUEVO: Inicializar el dashboard del profesor cuando se muestra
      if (id === 'dashboard-profesor') {
        setTimeout(() => inicializarDashboardProfesor(), 100);
      }
    }
    // ------------------- Login -------------------
    const form = document.getElementById('loginForm');
    const errorBox = document.getElementById('loginError');
    if (form) {
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const user = document.getElementById('nombreUsuario').value.trim();
        const pass = document.getElementById('password').value.trim();
        const robot = document.getElementById('chkRobot').checked;
        
        if (!user || !pass) {
        showError('Completa usuario y contrase√±a.');
        return;
        }
        if (!robot) {
        showError('Confirma la casilla "No soy un robot".');
        return;
        }
        
        // LOGIN CON BASE DE DATOS
        const usuario = DB.login(user, pass);
        
        if (!usuario) {
        showError('Usuario o contrase√±a incorrectos.');
        return;
        }
        
        // Guardar sesi√≥n actual
        sessionStorage.setItem('usuarioActual', JSON.stringify(usuario));
        
        const avatarUrl = "https://i.pravatar.cc/100?u=" + encodeURIComponent(user);
        
        ['estudiante', 'profesor', 'coordinador'].forEach(rol => {
        const nameEl = document.getElementById('nombre-display-' + rol);
        const avatarEl = document.getElementById('avatar-display-' + rol);
        if (nameEl) nameEl.textContent = usuario.nombre;
        if (avatarEl) avatarEl.src = avatarUrl;
        });
        
        mostrarSeccion('dashboard-' + usuario.rol);
        
        // Inicializar seg√∫n el rol
        if (usuario.rol === 'estudiante') {
        setTimeout(() => {
            cargarDatosEstudiante();
        }, 100);
        } else if (usuario.rol === 'profesor') {
        setTimeout(() => {
            inicializarDashboardProfesor();
        }, 100);
        } else if (usuario.rol === 'coordinador') {
        setTimeout(() => {
            inicializarDashboardCoordinador();
        }, 100);
        }
    });
    }

    // ==================== FORMULARIO DE SOLICITUD ====================
    const formSolicitud = document.getElementById('solicitudForm');
    if (formSolicitud) {
    formSolicitud.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const usuario = obtenerUsuarioActual();
        if (!usuario) {
        alert('Debes iniciar sesi√≥n primero');
        cerrarSesion();
        return;
        }
        
        const lineaIdElement = document.getElementById('modal-linea');
        const lineaId = parseInt(lineaIdElement.dataset.lineaId);
        
        if (!lineaId) {
        alert('Error: No se pudo identificar la l√≠nea de √©nfasis');
        return;
        }
        
        // Validar checkbox de declaraci√≥n
        if (!document.getElementById('declaracion-veracidad').checked) {
        alert('Debes aceptar la declaraci√≥n de veracidad');
        return;
        }
        
        // Recopilar archivos
        const archivos = {
        notas: document.getElementById('archivo-notas').files[0]?.name || 'certificado_notas.pdf',
        motivacion: document.getElementById('archivo-motivacion').files[0]?.name || 'carta_motivacion.pdf',
        prerrequisitos: Array.from(document.getElementById('archivo-prerrequisitos').files || []).map(f => f.name),
        otros: Array.from(document.getElementById('archivo-otros').files || []).map(f => f.name)
        };
        
        const datos = {
        estudianteId: usuario.id,
        lineaEnfasisId: lineaId,
        nombre: document.getElementById('solicitud-nombre').value,
        cedula: document.getElementById('solicitud-cedula').value,
        email: document.getElementById('solicitud-email').value,
        telefono: document.getElementById('solicitud-telefono').value,
        programa: document.getElementById('solicitud-programa').value,
        semestre: document.getElementById('solicitud-semestre').value,
        promedio: parseFloat(document.getElementById('solicitud-promedio').value),
        codigo: document.getElementById('solicitud-codigo').value,
        archivos: archivos
        };
        
        // Crear solicitud en BD
        DB.crearSolicitud(datos);
        
        // Cerrar modal
        closeSolicitudModal();
        
        // Recargar solicitudes
        renderSolicitudes();
        
        // Mostrar confirmaci√≥n
        mostrarConfirmacion(
        '¬°Solicitud Enviada!',
        'Tu solicitud ha sido registrada exitosamente. El coordinador la revisar√° pronto y recibir√°s una notificaci√≥n con la respuesta.'
        );
    });
    }

    // Eventos de roles
    roleButtons().forEach(btn => {
    btn.addEventListener('click', () => {
        setRole(btn.dataset.role);
        document.getElementById('menu-mobile')?.classList.add('hidden');
    });
    });
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const user = document.getElementById('nombreUsuario').value.trim();
        const pass = document.getElementById('password').value.trim();
        const robot = document.getElementById('chkRobot').checked;
        
        if (!user || !pass) {
          showError('Completa usuario y contrase√±a.');
          return;
        }
        if (!robot) {
          showError('Confirma la casilla "No soy un robot".');
          return;
        }
        
        // LOGIN CON BASE DE DATOS
        const usuario = DB.login(user, pass);
        
        if (!usuario) {
          showError('Usuario o contrase√±a incorrectos.');
          return;
        }
        
        // Guardar sesi√≥n actual
        sessionStorage.setItem('usuarioActual', JSON.stringify(usuario));
        
        const avatarUrl = "https://i.pravatar.cc/100?u=" + encodeURIComponent(user);
        
        ['estudiante', 'profesor', 'coordinador'].forEach(rol => {
          const nameEl = document.getElementById('nombre-display-' + rol);
          const avatarEl = document.getElementById('avatar-display-' + rol);
          if (nameEl) nameEl.textContent = usuario.nombre;
          if (avatarEl) avatarEl.src = avatarUrl;
        });
        
        mostrarSeccion('dashboard-' + usuario.rol);
        
        // Inicializar seg√∫n el rol
    if (usuario.rol === 'estudiante') {
      setTimeout(() => {
        cargarDatosEstudiante();
      }, 100);
    } else if (usuario.rol === 'profesor') {
      setTimeout(() => {
        inicializarDashboardProfesor();
      }, 100);
    } else if (usuario.rol === 'coordinador') {
      setTimeout(() => {
        inicializarDashboardCoordinador();
      }, 100);
    }
  });

    function showError(msg) {
      if (!errorBox) return;
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
      setTimeout(() => errorBox.classList.add('hidden'), 4000);
    }
    // Obtener usuario actual de la sesi√≥n
    function obtenerUsuarioActual() {
      const saved = sessionStorage.getItem('usuarioActual');
      return saved ? JSON.parse(saved) : null;
    }
    // ------------------- Modal de detalles de l√≠nea -------------------
    

    function closeDetallesModal() {
      const modal = document.getElementById('modal-detalles-linea');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      currentLineaDetails = null;
    }

    function descargarSyllabus() {
      if (currentLineaDetails) {
        const linea = lineasData[currentLineaDetails];
        agregarNotificacion(`Descargando syllabus de ${linea.titulo}...`);
        // Aqu√≠ ir√≠a la l√≥gica real de descarga
      }
    }

    function contactarProfesor() {
      if (currentLineaDetails) {
        const linea = lineasData[currentLineaDetails];
        agregarNotificacion(`Enviando mensaje a ${linea.profesor}...`);
        // Aqu√≠ ir√≠a la l√≥gica real de contacto
      }
    }
    // ------------------- Modal de solicitud -------------------
    function openSolicitudModal(linea) {
      const modal = document.getElementById('modal-solicitud');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('modal-linea').value = linea;
        document.getElementById('modal-linea-name').textContent = linea;
        // Limpiar archivos previos
        ['archivo-notas', 'archivo-motivacion', 'archivo-prerrequisitos', 'archivo-otros'].forEach(id => {
          const input = document.getElementById(id);
          if (input) input.value = '';
        });
      }
    }

    function closeSolicitudModal() {
      const modal = document.getElementById('modal-solicitud');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('solicitudForm').reset();
      }
    }
    // ------------------- Gesti√≥n de solicitudes -------------------
    // ------------------- Gesti√≥n de solicitudes CON BD -------------------
function cargarDatosEstudiante() {
  const usuario = obtenerUsuarioActual();
  if (!usuario) return;
  
  renderSolicitudes();
  generarCalendario();
  cargarLineasDisponibles(); // ‚Üê Esta l√≠nea debe estar aqu√≠
  cargarNotificacionesEstudiante();
}

function cargarLineasDisponibles() {
  const lineas = DB.obtenerLineasEnfasis();
  // Las l√≠neas ya est√°n en el HTML, solo actualizar cupos desde BD
  lineas.forEach(linea => {
    // Aqu√≠ puedes actualizar din√°micamente si quieres
  });
}

function cargarNotificacionesEstudiante() {
  const usuario = obtenerUsuarioActual();
  if (!usuario) return;
  
  const notificaciones = DB.obtenerNotificaciones(usuario.id);
  const lista = document.getElementById('lista-notificaciones');
  if (!lista) return;
  
  lista.innerHTML = '';
  if (notificaciones.length === 0) {
    lista.innerHTML = '<li class="text-gray-500 text-sm">No hay notificaciones</li>';
    return;
  }
  
  notificaciones.slice(0, 5).forEach(notif => {
    const li = document.createElement('li');
    li.className = `bg-gray-50 p-2 rounded cursor-pointer hover:bg-gray-100 ${notif.leida ? '' : 'border-l-2 border-blue-500'}`;
    li.onclick = () => marcarComoLeida(notif.id);
    li.innerHTML = `
      <div class="font-medium text-sm">${notif.titulo}</div>
      <div class="text-xs text-gray-600">${notif.mensaje}</div>
      <div class="text-xs text-gray-400 mt-1">${formatearFecha(notif.fechaCreacion)}</div>
    `;
    lista.appendChild(li);
  });
}

async function marcarComoLeida(notifId) {
  await DB.marcarNotificacionLeida(notifId);
  cargarNotificacionesEstudiante();
}

function formatearFecha(fecha) {
  const date = new Date(fecha);
  const ahora = new Date();
  const diff = ahora - date;
  
  if (diff < 60000) return 'Hace un momento';
  if (diff < 3600000) return `Hace ${Math.floor(diff / 60000)} minutos`;
  if (diff < 86400000) return `Hace ${Math.floor(diff / 3600000)} horas`;
  return date.toLocaleDateString('es-CO');
}

// Escuchar actualizaciones de la BD
window.addEventListener('db-updated', () => {
  const usuario = obtenerUsuarioActual();
  if (usuario && usuario.rol === 'estudiante') {
    cargarNotificacionesEstudiante();
    renderSolicitudes();
  }
});

function renderSolicitudes() {
  const usuario = obtenerUsuarioActual();
  if (!usuario) return;
  
  const tbody = document.getElementById('solicitudes-tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  
  const solicitudes = DB.obtenerSolicitudesEstudiante(usuario.id);
  
  if (solicitudes.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-3">No hay solicitudes registradas</td></tr>`;
    return;
  }
  
  solicitudes.forEach(req => {
    const tr = document.createElement('tr');
    tr.className = 'border-t hover:bg-gray-50';
    let estadoClass = 'bg-yellow-100 text-yellow-800';
    if (req.estado === 'aprobada') estadoClass = 'bg-green-100 text-green-800';
    if (req.estado === 'cancelada' || req.estado === 'rechazada') estadoClass = 'bg-red-100 text-red-800';
    
    const fecha = new Date(req.fechaSolicitud).toLocaleDateString('es-CO');
    
    tr.innerHTML = `
      <td class="p-3 font-medium">${req.lineaNombre}</td>
      <td class="p-3">${req.programa}</td>
      <td class="p-3">${fecha}</td>
      <td class="p-3"><span class="px-3 py-1 rounded-full text-xs font-medium ${estadoClass}">${req.estado}</span></td>
      <td class="p-3">
        <button onclick="cancelarSolicitudPorId(${req.id}, this)"
                 class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-colors ${req.estado !== 'pendiente' ? 'opacity-50 cursor-not-allowed' : ''}"
                 ${req.estado !== 'pendiente' ? 'disabled' : ''}
                title="${req.estado !== 'pendiente' ? 'No se puede cancelar' : 'Cancelar esta solicitud'}">
          ${req.estado === 'cancelada' ? 'Cancelada' : 'Cancelar'}
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function cancelarSolicitudPorId(id, btn) {
  if (btn.disabled) return;
  if (!confirm('¬øEst√°s seguro de cancelar esta solicitud?')) return;
  
  if (DB.cancelarSolicitud(id)) {
    renderSolicitudes();
    agregarNotificacion("Solicitud cancelada");
  }
}

    // ------------------- Sistema de confirmaciones -------------------
    function mostrarConfirmacion(titulo, mensaje) {
      // Crear modal de confirmaci√≥n din√°mico
      const modalHTML = `
        <div id="modal-confirmacion" class="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/60"></div>
          <div class="relative bg-white rounded-2xl shadow-xl max-w-md w-full p-6 z-10">
            <div class="text-center">
              <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <span class="text-green-600 text-2xl">‚úì</span>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">${titulo}</h3>
              <p class="text-sm text-gray-600 mb-6">${mensaje}</p>
              <button onclick="cerrarConfirmacion()" class="bg-udem-rojo text-white px-6 py-2 rounded-lg hover:bg-udem-rojo-hover transition-colors">
                Entendido
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function cerrarConfirmacion() {
      const modal = document.getElementById('modal-confirmacion');
      if (modal) {
        modal.remove();
      }
    }
    // ------------------- Notificaciones -------------------
    async function agregarNotificacion(mensaje) {
        const usuario = obtenerUsuarioActual();
        if (!usuario) return;
        
        // Crear notificaci√≥n en la BD
        await DB.crearNotificacion({
            usuarioId: usuario.id,
            titulo: 'Notificaci√≥n del sistema',
            mensaje: mensaje,
            tipo: 'info'
        });
        
        // Recargar notificaciones
        cargarNotificacionesEstudiante();
        }
    // ------------------- Filtros -------------------
    // ------------------- Cargar l√≠neas desde BD -------------------
function cargarLineasDisponibles() {
  const container = document.getElementById('lista-lineas');
  if (!container) return;
  
  container.innerHTML = '';
  const lineas = DB.obtenerLineasEnfasis();
  
  if (lineas.length === 0) {
    container.innerHTML = '<div class="col-span-2 text-center text-gray-500 p-6">No hay l√≠neas de √©nfasis disponibles actualmente.</div>';
    return;
  }
  
  const colores = [
    'from-white to-blue-50',
    'from-white to-green-50',
    'from-white to-purple-50',
    'from-white to-yellow-50',
    'from-white to-pink-50',
    'from-white to-indigo-50'
  ];
  
  lineas.forEach((linea, index) => {
    const card = document.createElement('div');
    card.className = `linea-card bg-gradient-to-br ${colores[index % colores.length]} p-6 rounded-2xl shadow hover:shadow-lg transition-shadow`;
    card.setAttribute('data-carrera', linea.programa);
    
    // Calcular porcentaje de ocupaci√≥n
    const ocupacion = linea.cuposTotales - linea.cuposDisponibles;
    const porcentaje = (ocupacion / linea.cuposTotales) * 100;
    let colorCupos = 'text-green-600';
    if (porcentaje > 80) colorCupos = 'text-red-600';
    else if (porcentaje > 60) colorCupos = 'text-orange-600';
    else if (porcentaje > 40) colorCupos = 'text-blue-600';
    
    card.innerHTML = `
      <h3 class="text-lg font-semibold text-gray-700">${linea.nombre}</h3>
      <p class="text-gray-500">Cupos: <span class="${colorCupos} font-semibold">${linea.cuposDisponibles}/${linea.cuposTotales}</span></p>
      <p class="text-gray-500">Profesor: ${linea.profesorNombre}</p>
      <p class="text-gray-500">Prerrequisitos: ${linea.prerrequisitos || 'Ninguno'}</p>
      <p class="text-sm text-gray-400 mt-2">Modalidad: ${linea.modalidad} | Duraci√≥n: ${linea.duracion} semanas</p>
      <p class="text-sm text-gray-400">Horario: ${linea.horario}</p>
      <div class="mt-4 flex flex-wrap gap-2">
        <button onclick="verDetallesLineaBD(${linea.id})" class="bg-udem-azul text-white px-4 py-2 rounded-lg hover:bg-udem-azul-hover transition-colors" title="Ver informaci√≥n completa de la l√≠nea">
          Ver Detalles
        </button>
        <button onclick="openSolicitudModalBD(${linea.id})" class="bg-udem-rojo text-white px-4 py-2 rounded-lg hover:bg-udem-rojo-hover transition-colors" title="Iniciar proceso de inscripci√≥n" ${linea.cuposDisponibles === 0 ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>
          ${linea.cuposDisponibles === 0 ? 'Sin Cupos' : 'Solicitar'}
        </button>
      </div>
    `;
    
    container.appendChild(card);
  });
}

function verDetallesLineaBD(lineaId) {
  const linea = DB.obtenerLineaEnfasis(lineaId);
  if (!linea) return;
  
  // Rellenar modal existente
  document.getElementById('modal-titulo-linea').textContent = linea.nombre;
  document.getElementById('modal-programa-linea').textContent = linea.programa;
  document.getElementById('modal-cupos').textContent = `${linea.cuposDisponibles}/${linea.cuposTotales}`;
  document.getElementById('modal-modalidad').textContent = linea.modalidad;
  document.getElementById('modal-duracion').textContent = `${linea.duracion} semanas`;
  document.getElementById('modal-inicio').textContent = new Date(linea.fechaInicio).toLocaleDateString('es-CO');
  document.getElementById('modal-creditos').textContent = linea.creditos;
  document.getElementById('modal-profesor').textContent = linea.profesorNombre;
  document.getElementById('modal-horario').textContent = linea.horario;
  document.getElementById('modal-aula').textContent = linea.aula;
  document.getElementById('modal-descripcion').textContent = linea.descripcion || 'Descripci√≥n no disponible';
  
  // Prerrequisitos
  const prereqList = document.getElementById('modal-prerrequisitos');
  const prereqs = linea.prerrequisitos ? linea.prerrequisitos.split(',') : [];
  prereqList.innerHTML = prereqs.length > 0 
    ? prereqs.map(p => `<li>‚Ä¢ ${p.trim()}</li>`).join('') 
    : '<li>‚Ä¢ Ninguno</li>';
  
  // Competencias
  const compList = document.getElementById('modal-competencias');
  const comps = linea.competencias ? linea.competencias.split(',') : [];
  compList.innerHTML = comps.length > 0 
    ? comps.map(c => `<li>‚Ä¢ ${c.trim()}</li>`).join('') 
    : '<li>‚Ä¢ No especificadas</li>';
  
  // Herramientas
  const herrList = document.getElementById('modal-herramientas');
  const herrs = linea.herramientas ? linea.herramientas.split(',') : [];
  herrList.innerHTML = herrs.length > 0 
    ? herrs.map(h => `<li>‚Ä¢ ${h.trim()}</li>`).join('') 
    : '<li>‚Ä¢ No especificadas</li>';
  
  // Guardar ID para usar despu√©s
  currentLineaDetails = linea.id;
  
  const modal = document.getElementById('modal-detalles-linea');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function openSolicitudModalBD(lineaId) {
  const linea = DB.obtenerLineaEnfasis(lineaId);
  if (!linea) return;
  
  const modal = document.getElementById('modal-solicitud');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('modal-linea').value = linea.nombre;
    document.getElementById('modal-linea').dataset.lineaId = lineaId;
    document.getElementById('modal-linea-name').textContent = linea.nombre;
    
    // Verificar conflictos de horario con cursos ya inscritos
    const usuarioActual = obtenerUsuarioActual(); // <-- CAMBIO AQU√ç: nombre diferente
    if (usuarioActual) {
      const inscripciones = DB.obtenerInscripcionesEstudiante(usuarioActual.id);
      const conflictos = inscripciones.filter(insc => {
        return insc.horario && linea.horario && hayConflictoHorario(insc.horario, linea.horario);
      });
      
      if (conflictos.length > 0) {
        const mensaje = `‚ö†Ô∏è ADVERTENCIA: Esta l√≠nea tiene conflicto de horario con:\n${conflictos.map(c => `‚Ä¢ ${c.cursoNombre} (${c.horario})`).join('\n')}\n\n¬øDeseas continuar de todos modos?`;
        if (!confirm(mensaje)) {
          closeSolicitudModal();
          return;
        }
      }
      
      // Pre-llenar con datos del usuario si est√° disponible
      document.getElementById('solicitud-nombre').value = usuarioActual.nombre || '';
      document.getElementById('solicitud-cedula').value = usuarioActual.cedula || '';
      document.getElementById('solicitud-email').value = usuarioActual.email || '';
      document.getElementById('solicitud-telefono').value = usuarioActual.telefono || '';
      document.getElementById('solicitud-programa').value = usuarioActual.programa || '';
      document.getElementById('solicitud-semestre').value = usuarioActual.semestre || '';
      document.getElementById('solicitud-promedio').value = usuarioActual.promedio || '';
      document.getElementById('solicitud-codigo').value = usuarioActual.codigo || '';
    }
    
    // Limpiar archivos previos
    ['archivo-notas', 'archivo-motivacion', 'archivo-prerrequisitos', 'archivo-otros'].forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = '';
    });
  }
}

function openSolicitudModalFromDetails() {
  if (currentLineaDetails) {
    closeDetallesModal();
    setTimeout(() => openSolicitudModalBD(currentLineaDetails), 300);
  }
}
    
    function resetFiltroCarrera() {
      const filtro = document.getElementById('filtro-carrera');
      if (filtro) {
        filtro.value = 'Todas';
        filtrarLineas();
      }
    }

    function filtrarLineas() {
      const filtro = document.getElementById('filtro-carrera');
      const cards = document.querySelectorAll('.linea-card');
      if (!filtro) return;
      
      const carreraSeleccionada = filtro.value;
      cards.forEach(card => {
        const carreraCard = card.getAttribute('data-carrera');
        if (carreraSeleccionada === 'Todas' || carreraCard === carreraSeleccionada) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }
    // ------------------- Calendario -------------------
    function generarCalendario() {
  const calendario = document.getElementById("calendario");
  if (!calendario) return;
  
  calendario.innerHTML = "";
  const hoy = new Date();
  const mes = hoy.getMonth();
  const anio = hoy.getFullYear();
  const primerDia = new Date(anio, mes, 1);
  const ultimoDia = new Date(anio, mes + 1, 0);
  const diasMes = ultimoDia.getDate();
  const inicioSemana = primerDia.getDay();
  
  // Obtener eventos reales de inscripciones del estudiante
  const usuario = obtenerUsuarioActual();
  const tareas = {};
  
  if (usuario && usuario.rol === 'estudiante') {
    const inscripciones = DB.obtenerInscripcionesEstudiante(usuario.id);
    inscripciones.forEach(insc => {
      // Simular algunas fechas de eventos basados en la inscripci√≥n
      const dia = Math.floor(Math.random() * 28) + 1;
      if (!tareas[dia]) {
        tareas[dia] = `Clase: ${insc.cursoNombre}`;
      }
    });
    
    // Agregar fechas de solicitudes
    const solicitudes = DB.obtenerSolicitudesEstudiante(usuario.id);
    solicitudes.forEach(sol => {
      const fecha = new Date(sol.fechaSolicitud);
      if (fecha.getMonth() === mes && fecha.getFullYear() === anio) {
        tareas[fecha.getDate()] = `Solicitud: ${sol.lineaNombre}`;
      }
    });
  }
  
  const diasSemana = ["D", "L", "M", "X", "J", "V", "S"];
  diasSemana.forEach(d => {
    const cell = document.createElement("div");
    cell.textContent = d;
    cell.className = "text-center font-semibold text-gray-600 text-xs";
    calendario.appendChild(cell);
  });
  
  for (let i = 0; i < inicioSemana; i++) {
    calendario.appendChild(document.createElement("div"));
  }
  
  for (let d = 1; d <= diasMes; d++) {
    const cell = document.createElement("div");
    cell.textContent = d;
    cell.className = "h-8 flex items-center justify-center rounded cursor-pointer transition text-xs";
    
    if (d === hoy.getDate()) {
      cell.classList.add("bg-udem-rojo", "text-white", "font-bold");
    } else {
      cell.classList.add("hover:bg-gray-100");
    }
    
    if (tareas[d]) {
      cell.classList.add("bg-yellow-100", "border", "border-yellow-400");
      cell.title = tareas[d];
    }
    
    calendario.appendChild(cell);
  }
}
    // ------------------- Eventos y inicializaci√≥n -------------------
    // Password toggle
    document.getElementById('btnTogglePass') ?.addEventListener('click', () => {
      const input = document.getElementById('password');
      input.type = input.type === 'password' ? 'text' : 'password';
    });
    // Men√∫ m√≥vil
    document.getElementById('menu-toggle') ?.addEventListener('click', () => {
      document.getElementById('menu-mobile') ?.classList.toggle('hidden');
    });

    // Filtro de carreras
    document.getElementById('filtro-carrera') ?.addEventListener('change', filtrarLineas);
    // Cerrar sesi√≥n
    function cerrarSesion() {
      sessionStorage.removeItem('usuarioActual');
      solicitudesData = [];
      selectedRole = 'estudiante';
      ['estudiante', 'profesor', 'coordinador'].forEach(rol => {
        const nameEl = document.getElementById('nombre-display-' + rol);
        const avatarEl = document.getElementById('avatar-display-' + rol);
        if (nameEl) nameEl.textContent = '';
        if (avatarEl) avatarEl.src = '';
      });
      document.getElementById('loginForm')?.reset();
      mostrarSeccion('login');
    }
      selectedRole = 'estudiante';
      ['estudiante', 'profesor', 'coordinador'].forEach(rol => {
        const nameEl = document.getElementById('nombre-display-' + rol);
        const avatarEl = document.getElementById('avatar-display-' + rol);
        if (nameEl) nameEl.textContent = '';
        if (avatarEl) avatarEl.src = '';
      });
      document.getElementById('loginForm') ?.reset();
      mostrarSeccion('login');
    // Inicializaci√≥n
    setRole('estudiante');
    mostrarSeccion('login');
    

// ==================== PROFESOR - C√ìDIGO MEJORADO ====================

// --- DATOS SIMULADOS (Esto se reemplazar√° con BD real) ---
let cursosAsignados = [];

let baseDatosNotas = {};
let cursoActual = null;

// --- INICIALIZACI√ìN CUANDO SE MUESTRA EL DASHBOARD PROFESOR ---
// Modificar la funci√≥n mostrarSeccion existente para llamar a esto
function inicializarDashboardProfesor() {
  const usuario = obtenerUsuarioActual();
  if (!usuario) return;
  
  // Cargar cursos desde BD
  cursosAsignados = DB.obtenerCursosProfesor(usuario.id).map(c => ({
    id: c.codigo,
    nombre: c.nombre,
    codigo: c.codigo,
    lineaEnfasis: c.lineaEnfasis,
    semestre: c.semestre,
    horario: c.horario,
    aula: c.aula,
    estudiantes: c.estudiantes,
    estado: c.estado
  }));
  
  cargarCursosProfesor();
  cargarCalendarioProfesor();
  actualizarEstadisticasProfesor();
  cargarNotasGuardadas();
}

// --- GESTI√ìN DE PESTA√ëAS ---
function cambiarTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  const content = document.getElementById(`content-${tabName}`);
  if (content) content.classList.remove('hidden');
  
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('border-udem-rojo', 'text-udem-rojo');
    btn.classList.add('border-transparent', 'text-gray-500');
  });
  const btnActivo = document.getElementById(`tab-${tabName}`);
  if (btnActivo) {
    btnActivo.classList.remove('border-transparent', 'text-gray-500');
    btnActivo.classList.add('border-udem-rojo', 'text-udem-rojo');
  }
}

// --- CARGAR CURSOS ---
function cargarCursosProfesor() {
  const container = document.getElementById('lista-cursos');
  if (!container) return;
  container.innerHTML = '';
  
  cursosAsignados.forEach(curso => {
    const card = crearCardCurso(curso);
    container.appendChild(card);
  });
}

function crearCardCurso(curso) {
  const div = document.createElement('div');
  div.className = 'bg-white border-l-4 border-udem-azul rounded-lg p-5 shadow-md hover:shadow-lg transition-shadow';
  div.innerHTML = `
    <div class="flex justify-between items-start mb-3">
      <div>
        <h3 class="text-lg font-bold text-gray-800">${curso.nombre}</h3>
        <p class="text-sm text-gray-500">${curso.codigo} ‚Ä¢ ${curso.lineaEnfasis}</p>
      </div>
      <span class="px-3 py-1 rounded-full text-xs font-medium ${curso.estado === 'Activo' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
        ${curso.estado}
      </span>
    </div>
    <div class="grid grid-cols-2 gap-3 text-sm text-gray-600 mb-4">
      <div>üë• <strong>${curso.estudiantes}</strong> estudiantes</div>
      <div>üïê ${curso.horario}</div>
      <div>üìç ${curso.aula}</div>
      <div>üìÖ Semestre ${curso.semestre}</div>
    </div>
    <div class="flex gap-2 flex-wrap">
      <button onclick="abrirGestionNotas('${curso.id}')" 
              class="flex-1 bg-udem-azul text-white px-4 py-2 rounded-lg hover:bg-udem-azul-hover transition-colors text-sm font-medium">
        üìä Gestionar Notas
      </button>
      <button onclick="abrirGestionAsistencias('${curso.id}')" 
              class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium">
        üìã Gestionar Asistencias
      </button>
    </div>
  `;
  return div;
}

// --- ESTAD√çSTICAS ---
function actualizarEstadisticasProfesor() {
  const usuario = obtenerUsuarioActual();
  if (!usuario) return;
  
  const cursos = DB.obtenerCursosProfesor(usuario.id);
  const totalCursos = cursos.length;
  
  let totalEstudiantes = 0;
  let evaluacionesPendientes = 0;
  
  cursos.forEach(curso => {
    const estudiantes = DB.obtenerEstudiantesCurso(curso.id);
    totalEstudiantes += estudiantes.length;
    
    // Contar evaluaciones sin notas completas
    const evaluaciones = DB.obtenerEvaluacionesCurso(curso.id);
    estudiantes.forEach(est => {
      evaluaciones.forEach(ev => {
        const nota = DB.obtenerNotasEstudiante(est.estudianteId, curso.id)
          .find(n => n.evaluacionId === ev.id);
        if (!nota || nota.nota === 0) {
          evaluacionesPendientes++;
        }
      });
    });
  });
  
  // Actualizar interfaz
  const statCursos = document.getElementById('stat-cursos');
  const statEstudiantes = document.getElementById('stat-estudiantes');
  const statPendientes = document.getElementById('stat-pendientes');
  const statProxima = document.getElementById('stat-proxima');
  const totalCount = document.getElementById('total-cursos-count');
  
  if (statCursos) statCursos.textContent = totalCursos;
  if (statEstudiantes) statEstudiantes.textContent = totalEstudiantes;
  if (statPendientes) statPendientes.textContent = evaluacionesPendientes;
  if (totalCount) totalCount.textContent = totalCursos;
  
  // Pr√≥xima clase (tomar el primer curso)
  if (statProxima && cursos.length > 0) {
    const hoy = new Date();
    const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    statProxima.textContent = `${dias[hoy.getDay()]} - ${cursos[0].horario}`;
  } else if (statProxima) {
    statProxima.textContent = 'Sin clases';
  }
}
// Al final de actualizarEstadisticasProfesor(), AGREGAR:

// Auto-actualizar cuando hay cambios
window.addEventListener('db-updated', () => {
  const usuario = obtenerUsuarioActual();
  if (usuario && usuario.rol === 'profesor') {
    actualizarEstadisticasProfesor();
    cargarCursosProfesor();
  }
});
// --- CALENDARIO ---
function cargarCalendarioProfesor() {
  const container = document.getElementById('calendario-lista');
  if (!container) return;
  
  const usuario = obtenerUsuarioActual();
  if (!usuario) return;
  
  const cursos = DB.obtenerCursosProfesor(usuario.id);
  container.innerHTML = '';
  
  if (cursos.length === 0) {
    container.innerHTML = '<div class="text-center text-gray-500 p-4">No tienes cursos asignados</div>';
    return;
  }
  
  // Obtener d√≠a actual
  const hoy = new Date();
  const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
  const diaActual = diasSemana[hoy.getDay()];
  
  cursos.forEach(curso => {
    const div = document.createElement('div');
    
    // Marcar si es hoy
    const esHoy = curso.horario.toLowerCase().includes(diaActual.toLowerCase().substring(0, 3));
    
    div.className = `flex items-center justify-between p-3 rounded-lg border ${
      esHoy ? 'bg-green-50 border-green-300' : 'bg-white'
    }`;
    
    div.innerHTML = `
      <div class="flex-1">
        <div class="font-semibold text-gray-800">${curso.nombre}</div>
        <div class="text-sm text-gray-500">${curso.horario} ‚Ä¢ ${curso.aula}</div>
        <div class="text-xs text-gray-400 mt-1">${curso.estudiantes} estudiantes</div>
      </div>
      <div class="text-right">
        ${esHoy ? '<span class="text-2xl">üîî</span>' : '<span class="text-2xl">üìö</span>'}
        ${esHoy ? '<div class="text-xs text-green-600 font-medium mt-1">HOY</div>' : ''}
      </div>
    `;
    container.appendChild(div);
  });
}
// --- GESTI√ìN DE NOTAS ---
function abrirGestionNotas(cursoId) {
  cursoActual = cursoId;
  const curso = cursosAsignados.find(c => c.id === cursoId);
  if (!curso) return;

  // Cargar datos reales de la BD
  const cursoReal = DB.cursos.find(c => c.codigo === cursoId);
  if (!cursoReal) return;

  const estudiantes = DB.obtenerEstudiantesCurso(cursoReal.id);
  const evaluaciones = DB.obtenerEvaluacionesCurso(cursoReal.id);

  // Inicializar datos si no existen
  if (!baseDatosNotas[cursoId]) {
    baseDatosNotas[cursoId] = {
      evaluaciones: evaluaciones.length > 0 ? evaluaciones.map(ev => ({
        nombre: ev.nombre,
        porcentaje: ev.porcentaje
      })) : [
        { nombre: 'Parcial 1', porcentaje: 30 },
        { nombre: 'Parcial 2', porcentaje: 30 },
        { nombre: 'Proyecto Final', porcentaje: 40 }
      ],
      estudiantes: estudiantes.map(est => {
        const notas = DB.obtenerNotasEstudiante(est.estudianteId, cursoReal.id);
        const notasArray = evaluaciones.map(ev => {
          const nota = notas.find(n => n.evaluacionId === ev.id);
          return nota ? nota.nota : 0;
        });
        return {
          nombre: est.nombre,
          codigo: est.codigo,
          notas: notasArray.length > 0 ? notasArray : [0, 0, 0]
        };
      })
    };
  }

  document.getElementById('titulo-curso-notas').textContent = `Gesti√≥n de Notas: ${curso.nombre}`;
  document.getElementById('info-curso-notas').textContent = `${curso.codigo} ‚Ä¢ ${estudiantes.length} estudiantes`;
  
  document.getElementById('modal-gestion-notas').classList.remove('hidden');
  document.getElementById('modal-gestion-notas').classList.add('flex');
  
  renderTablaNotas();
}
function closeGestionNotas() {
  document.getElementById('modal-gestion-notas').classList.add('hidden');
  document.getElementById('modal-gestion-notas').classList.remove('flex');
  cursoActual = null;
}

// ==================== GESTI√ìN DE ASISTENCIAS ====================

let cursoAsistenciaActual = null;
let fechaAsistenciaActual = null;

function abrirGestionAsistencias(cursoId) {
  cursoAsistenciaActual = cursoId;
  const curso = cursosAsignados.find(c => c.id === cursoId);
  if (!curso) return;

  document.getElementById('titulo-curso-asistencias').textContent = `Gesti√≥n de Asistencias: ${curso.nombre}`;
  document.getElementById('info-curso-asistencias').textContent = `${curso.codigo} ‚Ä¢ ${curso.estudiantes} estudiantes`;
  
  // Fecha de hoy por defecto
  const hoy = new Date().toISOString().split('T')[0];
  document.getElementById('fecha-asistencia').value = hoy;
  fechaAsistenciaActual = hoy;
  
  document.getElementById('modal-gestion-asistencias').classList.remove('hidden');
  document.getElementById('modal-gestion-asistencias').classList.add('flex');
  
  cargarAsistenciaFecha();
}

function closeGestionAsistencias() {
  document.getElementById('modal-gestion-asistencias').classList.add('hidden');
  document.getElementById('modal-gestion-asistencias').classList.remove('flex');
  cursoAsistenciaActual = null;
  fechaAsistenciaActual = null;
}

function cargarAsistenciaFecha() {
  if (!cursoAsistenciaActual) return;
  
  fechaAsistenciaActual = document.getElementById('fecha-asistencia').value;
  const cursoReal = DB.cursos.find(c => c.codigo === cursoAsistenciaActual);
  if (!cursoReal) return;
  
  const estudiantes = DB.obtenerEstudiantesCurso(cursoReal.id);
  const asistenciasHoy = DB.obtenerAsistenciasCurso(cursoReal.id, fechaAsistenciaActual);
  
  const tbody = document.getElementById('tbody-asistencias');
  tbody.innerHTML = '';
  
  estudiantes.forEach((est, idx) => {
    const asistencia = asistenciasHoy.find(a => a.estudianteId === est.estudianteId);
    const porcentaje = DB.calcularPorcentajeAsistencia(est.estudianteId, cursoReal.id);
    
    const tr = document.createElement('tr');
    tr.className = 'border-t hover:bg-gray-50';
    tr.innerHTML = `
      <td class="p-3 border font-medium">${est.nombre}</td>
      <td class="p-3 border text-gray-600">${est.codigo}</td>
      <td class="p-3 border text-center">
        <input type="checkbox" 
               id="asist-${idx}" 
               ${asistencia?.presente ? 'checked' : ''}
               class="w-5 h-5 accent-green-600 cursor-pointer"
               onchange="marcarAsistencia(${est.estudianteId}, this.checked)">
      </td>
      <td class="p-3 border text-center font-semibold ${porcentaje >= 80 ? 'text-green-600' : porcentaje >= 60 ? 'text-yellow-600' : 'text-red-600'}">
        ${porcentaje.toFixed(1)}%
      </td>
      <td class="p-3 border">
        <input type="text" 
               id="obs-${idx}"
               value="${asistencia?.observaciones || ''}"
               placeholder="Observaciones..."
               class="w-full border rounded px-2 py-1 text-sm">
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function marcarAsistencia(estudianteId, presente) {
  // Solo marca visualmente, se guarda con el bot√≥n "Guardar"
}

async function guardarAsistencias() {
  if (!cursoAsistenciaActual || !fechaAsistenciaActual) return;
  
  const cursoReal = DB.cursos.find(c => c.codigo === cursoAsistenciaActual);
  if (!cursoReal) return;
  
  const estudiantes = DB.obtenerEstudiantesCurso(cursoReal.id);
  
  for (let i = 0; i < estudiantes.length; i++) {
    const checkbox = document.getElementById(`asist-${i}`);
    const obsInput = document.getElementById(`obs-${i}`);
    
    await DB.registrarAsistencia({
      estudianteId: estudiantes[i].estudianteId,
      cursoId: cursoReal.id,
      fecha: fechaAsistenciaActual,
      presente: checkbox.checked,
      observaciones: obsInput.value
    });
  }
  
  alert('‚úÖ Asistencias guardadas correctamente');
  cargarAsistenciaFecha(); // Recargar para actualizar porcentajes
}

function generarReporteAsistencias() {
  if (!cursoAsistenciaActual) return;
  
  const cursoReal = DB.cursos.find(c => c.codigo === cursoAsistenciaActual);
  if (!cursoReal) return;
  
  const curso = cursosAsignados.find(c => c.id === cursoAsistenciaActual);
  const estudiantes = DB.obtenerEstudiantesCurso(cursoReal.id);
  
  const fecha = new Date().toLocaleDateString('es-CO', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  // Encabezado del reporte
  let csv = `REPORTE DE ASISTENCIAS\n`;
  csv += `Curso:,${curso.nombre}\n`;
  csv += `C√≥digo:,${curso.codigo}\n`;
  csv += `Profesor:,${obtenerUsuarioActual().nombre}\n`;
  csv += `Fecha de Generaci√≥n:,${fecha}\n\n`;
  
  csv += 'RESUMEN POR ESTUDIANTE\n';
  csv += 'ESTUDIANTE,C√ìDIGO,% ASISTENCIA,TOTAL CLASES,ASISTI√ì,FALT√ì\n';
  
  estudiantes.forEach(est => {
    const porcentaje = DB.calcularPorcentajeAsistencia(est.estudianteId, cursoReal.id);
    const asistencias = DB.obtenerAsistenciasEstudiante(est.estudianteId, cursoReal.id);
    const presentes = asistencias.filter(a => a.presente).length;
    const ausentes = asistencias.length - presentes;
    
    csv += `${est.nombre},${est.codigo},${porcentaje.toFixed(1)}%,${asistencias.length},${presentes},${ausentes}\n`;
  });
  
  // Agregar detalle por fecha
  const todasAsistencias = DB.obtenerAsistenciasCurso(cursoReal.id);
  const fechasUnicas = [...new Set(todasAsistencias.map(a => a.fecha))].sort();
  
  if (fechasUnicas.length > 0) {
    csv += '\n\nDETALLE POR FECHA\n';
    csv += 'FECHA,ESTUDIANTE,C√ìDIGO,ASISTI√ì,OBSERVACIONES\n';
    
    fechasUnicas.forEach(fecha => {
      const asistenciasFecha = todasAsistencias.filter(a => a.fecha === fecha);
      asistenciasFecha.forEach(asist => {
        const est = estudiantes.find(e => e.estudianteId === asist.estudianteId);
        if (est) {
          const asistio = asist.presente ? 'S√ç' : 'NO';
          const obs = asist.observaciones || '';
          csv += `${fecha},${est.nombre},${est.codigo},${asistio},"${obs}"\n`;
        }
      });
    });
  }
  
  // Estad√≠sticas generales
  const totalClases = fechasUnicas.length;
  const promedioAsistencia = estudiantes.reduce((sum, est) => {
    return sum + DB.calcularPorcentajeAsistencia(est.estudianteId, cursoReal.id);
  }, 0) / estudiantes.length;
  
  csv += `\n\nESTAD√çSTICAS GENERALES\n`;
  csv += `Total de Estudiantes:,${estudiantes.length}\n`;
  csv += `Total de Clases Registradas:,${totalClases}\n`;
  csv += `Promedio de Asistencia del Curso:,${promedioAsistencia.toFixed(1)}%\n`;
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `REPORTE_ASISTENCIAS_${curso.codigo}_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  
  alert('üìä Reporte de asistencias generado exitosamente');
}
function renderTablaNotas() {
  if (!cursoActual) return;
  const datos = baseDatosNotas[cursoActual];
  if (!datos) return;

  const thead = document.getElementById('thead-notas');
  thead.innerHTML = `
    <th class="p-3 border text-left sticky left-0 bg-udem-azul z-10">Estudiante</th>
    <th class="p-3 border text-left">C√≥digo</th>
  `;
  
  datos.evaluaciones.forEach((ev, i) => {
    thead.innerHTML += `
      <th class="p-3 border text-center">
        <div class="flex flex-col items-center gap-1">
          <input type="text" value="${ev.nombre}" 
                 onchange="cambiarNombreEval(${i}, this.value)"
                 class="bg-transparent border-b border-white/30 text-center text-white font-medium px-2 py-1 w-32"
                 title="Clic para editar nombre">
          <div class="flex items-center gap-1">
            <input type="number" min="0" max="100" step="1" value="${ev.porcentaje}"
                   onchange="cambiarPorcentaje(${i}, this.value)"
                   class="w-16 border rounded text-center text-xs bg-white text-gray-800 px-1 py-1"
                   title="Porcentaje de esta evaluaci√≥n">
            <span class="text-xs">%</span>
            <button onclick="eliminarEvaluacion(${i})" 
                    class="ml-1 text-white/70 hover:text-white text-xs" 
                    title="Eliminar evaluaci√≥n">
              üóëÔ∏è
            </button>
          </div>
        </div>
      </th>
    `;
  });
  thead.innerHTML += `<th class="p-3 border text-center bg-udem-rojo">Nota Final</th>`;

  const tbody = document.getElementById('tbody-notas');
  tbody.innerHTML = '';
  datos.estudiantes.forEach((est, idxEst) => {
    let row = `
      <tr class="border-t hover:bg-gray-50">
        <td class="p-3 border font-medium sticky left-0 bg-white z-10">${est.nombre}</td>
        <td class="p-3 border text-gray-600 text-sm">${est.codigo}</td>
    `;
    datos.evaluaciones.forEach((_, idxEv) => {
      row += `
        <td class="p-3 border text-center">
          <input type="number" min="0" max="5" step="0.1"
                 value="${est.notas[idxEv] ?? 0}"
                 onchange="cambiarNota(${idxEst}, ${idxEv}, this.value)"
                 class="w-20 border rounded text-center px-2 py-1 focus:ring-2 focus:ring-udem-azul focus:outline-none">
        </td>
      `;
    });
    row += `
        <td class="p-3 border text-center font-bold text-lg" id="final-${idxEst}">0.00</td>
      </tr>
    `;
    tbody.innerHTML += row;
  });

  calcularFinales();
  validarPorcentajes();
}

function cambiarNota(idxEst, idxEv, valor) {
  if (!cursoActual) return;
  baseDatosNotas[cursoActual].estudiantes[idxEst].notas[idxEv] = parseFloat(valor) || 0;
  calcularFinales();
}

function cambiarPorcentaje(idxEv, valor) {
  if (!cursoActual) return;
  baseDatosNotas[cursoActual].evaluaciones[idxEv].porcentaje = parseInt(valor) || 0;
  validarPorcentajes();
  calcularFinales();
}

function cambiarNombreEval(idxEv, nuevoNombre) {
  if (!cursoActual) return;
  baseDatosNotas[cursoActual].evaluaciones[idxEv].nombre = nuevoNombre;
}

function calcularFinales() {
  if (!cursoActual) return;
  const datos = baseDatosNotas[cursoActual];
  datos.estudiantes.forEach((est, i) => {
    let final = 0;
    datos.evaluaciones.forEach((ev, j) => {
      final += (est.notas[j] || 0) * ((ev.porcentaje || 0) / 100);
    });
    const el = document.getElementById(`final-${i}`);
    if (el) {
      el.textContent = final.toFixed(2);
      el.className = 'p-3 border text-center font-bold text-lg';
      if (final >= 4.0) el.classList.add('text-green-600');
      else if (final >= 3.0) el.classList.add('text-yellow-600');
      else el.classList.add('text-red-600');
    }
  });
}

function validarPorcentajes() {
  if (!cursoActual) return;
  const datos = baseDatosNotas[cursoActual];
  const total = datos.evaluaciones.reduce((acc, ev) => acc + (Number(ev.porcentaje) || 0), 0);
  const restante = 100 - total;
  
  const pEl = document.getElementById('porcentaje-restante');
  const btnGenerar = document.getElementById('btn-generar-reporte');
  if (!pEl || !btnGenerar) return;

  if (total === 100) {
    pEl.textContent = '‚úÖ Distribuci√≥n completa (100%)';
    pEl.className = 'text-sm font-medium px-3 py-2 rounded-lg bg-green-100 text-green-800';
    btnGenerar.disabled = false;
  } else if (total < 100) {
    pEl.textContent = `‚ö†Ô∏è Faltan ${restante}% por asignar`;
    pEl.className = 'text-sm font-medium px-3 py-2 rounded-lg bg-yellow-100 text-yellow-800';
    btnGenerar.disabled = true;
  } else {
    pEl.textContent = `‚ùå Exceso de ${Math.abs(restante)}% (corrija)`;
    pEl.className = 'text-sm font-medium px-3 py-2 rounded-lg bg-red-100 text-red-800';
    btnGenerar.disabled = true;
  }
}

function agregarEvaluacion() {
  if (!cursoActual) return;
  const datos = baseDatosNotas[cursoActual];
  datos.evaluaciones.push({ nombre: `Evaluaci√≥n ${datos.evaluaciones.length + 1}`, porcentaje: 0 });
  datos.estudiantes.forEach(est => est.notas.push(0));
  renderTablaNotas();
  if (typeof agregarNotificacion === 'function') {
    agregarNotificacion('Nueva evaluaci√≥n agregada');
  }
}

function eliminarEvaluacion(idxEv) {
  if (!cursoActual) return;
  if (!confirm('¬øEliminar esta evaluaci√≥n? Se perder√°n todas las notas asociadas.')) return;
  const datos = baseDatosNotas[cursoActual];
  datos.evaluaciones.splice(idxEv, 1);
  datos.estudiantes.forEach(est => est.notas.splice(idxEv, 1));
  renderTablaNotas();
  if (typeof agregarNotificacion === 'function') {
    agregarNotificacion('Evaluaci√≥n eliminada');
  }
}


async function guardarCambios() {
  if (!cursoActual) return;
  
  const datos = baseDatosNotas[cursoActual];
  const cursoReal = DB.cursos.find(c => c.codigo === cursoActual);
  if (!cursoReal) {
    alert('Error: No se encontr√≥ el curso');
    return;
  }
  
  // Guardar evaluaciones en Firebase
  const evaluacionesExistentes = DB.obtenerEvaluacionesCurso(cursoReal.id);
  
  // Eliminar evaluaciones viejas que ya no existen
  for (const ev of evaluacionesExistentes) {
    const existe = datos.evaluaciones.find(e => e.nombre === ev.nombre);
    if (!existe) {
      await DB.eliminarEvaluacion(ev.id);
    }
  }
  
  // Crear o actualizar evaluaciones
  for (const ev of datos.evaluaciones) {
    const existe = evaluacionesExistentes.find(e => e.nombre === ev.nombre);
    if (existe) {
      await DB.actualizarEvaluacion(existe.id, { 
        nombre: ev.nombre, 
        porcentaje: ev.porcentaje 
      });
    } else {
      await DB.crearEvaluacion({
        cursoId: cursoReal.id,
        nombre: ev.nombre,
        porcentaje: ev.porcentaje
      });
    }
  }
  
  // Recargar evaluaciones actualizadas
  const evaluacionesActualizadas = DB.obtenerEvaluacionesCurso(cursoReal.id);
  const estudiantes = DB.obtenerEstudiantesCurso(cursoReal.id);
  
  // Guardar notas de cada estudiante
  for (let i = 0; i < datos.estudiantes.length; i++) {
    const est = datos.estudiantes[i];
    const estudianteReal = estudiantes[i];
    if (!estudianteReal) continue;
    
    for (let j = 0; j < datos.evaluaciones.length; j++) {
      const evaluacion = evaluacionesActualizadas.find(e => e.nombre === datos.evaluaciones[j].nombre);
      if (!evaluacion) continue;
      
      await DB.guardarNota({
        evaluacionId: evaluacion.id,
        estudianteId: estudianteReal.estudianteId,
        cursoId: cursoReal.id,
        nota: est.notas[j] || 0
      });
    }
  }
  
  saveToStorage();
  
  if (typeof agregarNotificacion === 'function') {
    agregarNotificacion('‚úÖ Cambios guardados en Firebase');
  } else {
    alert('‚úÖ Cambios guardados correctamente');
  }
}

function generarReporteCurso() {
  if (!cursoActual) return;
  const datos = baseDatosNotas[cursoActual];
  const total = datos.evaluaciones.reduce((acc, ev) => acc + (Number(ev.porcentaje) || 0), 0);
  
  if (total !== 100) {
    alert('No se puede generar el reporte: la suma de porcentajes debe ser exactamente 100%');
    return;
  }

  calcularFinales();
  
  const curso = cursosAsignados.find(c => c.id === cursoActual);
  if (!curso) return;
  
  const fecha = new Date().toLocaleDateString('es-CO', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  // Crear CSV simple con solo nota final
  let csv = `REPORTE FINAL DE NOTAS\n`;
  csv += `Curso:,${curso.nombre}\n`;
  csv += `C√≥digo:,${curso.codigo}\n`;
  csv += `Profesor:,${obtenerUsuarioActual().nombre}\n`;
  csv += `Fecha de Generaci√≥n:,${fecha}\n\n`;
  
  csv += 'ESTUDIANTE,C√ìDIGO,NOTA FINAL,ESTADO\n';
  
  datos.estudiantes.forEach((est, idx) => {
    const finalEl = document.getElementById(`final-${idx}`);
    const final = parseFloat(finalEl ? finalEl.textContent : '0');
    const estado = final >= 3.0 ? 'APROBADO' : 'REPROBADO';
    csv += `${est.nombre},${est.codigo},${final.toFixed(2)},${estado}\n`;
  });
  
  // Estad√≠sticas
  const promedios = datos.estudiantes.map((est, idx) => {
    const finalEl = document.getElementById(`final-${idx}`);
    return parseFloat(finalEl ? finalEl.textContent : '0');
  });
  const promedioCurso = (promedios.reduce((a, b) => a + b, 0) / promedios.length).toFixed(2);
  const aprobados = promedios.filter(p => p >= 3.0).length;
  const reprobados = promedios.length - aprobados;
  
  csv += `\nESTAD√çSTICAS DEL CURSO\n`;
  csv += `Total Estudiantes:,${datos.estudiantes.length}\n`;
  csv += `Promedio del Curso:,${promedioCurso}\n`;
  csv += `Aprobados:,${aprobados}\n`;
  csv += `Reprobados:,${reprobados}\n`;

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `REPORTE_FINAL_NOTAS_${curso.codigo}_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  saveToStorage();
  if (typeof agregarNotificacion === 'function') {
    agregarNotificacion('üì• Reporte final de notas generado');
  }
  closeGestionNotas();
}
  const curso = cursosAsignados.find(c => c.id === cursoActual);
  const reporte = {
    curso: curso.nombre,
    codigo: curso.codigo,
    fecha: new Date().toLocaleString('es-CO'),
    evaluaciones: datos.evaluaciones,
    estudiantes: datos.estudiantes.map((est, idx) => ({
      nombre: est.nombre,
      codigo: est.codigo,
      notas: est.notas,
      final: Number(document.getElementById(`final-${idx}`)?.textContent || 0)
    }))
  };

  const blob = new Blob([JSON.stringify(reporte, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${reporte.codigo}_reporte_notas_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  saveToStorage();
  if (typeof agregarNotificacion === 'function') {
    agregarNotificacion('üì• Reporte generado y descargado');
  }
  closeGestionNotas();


// --- PERSISTENCIA DE DATOS (SIMULACI√ìN CON LOCALSTORAGE) ---
function cargarNotasGuardadas() {
  try {
    const saved = localStorage.getItem('notas_profesor_udem');
    if (saved) {
      baseDatosNotas = JSON.parse(saved);
    }
  } catch (e) {
    console.warn('No se pudieron cargar notas guardadas:', e);
  }
}

function saveToStorage() {
  try {
    localStorage.setItem('notas_profesor_udem', JSON.stringify(baseDatosNotas));
  } catch (e) {
    console.error('Error al guardar:', e);
  }
}

// --- FUNCIONES ADICIONALES ---
function verEstudiantesCurso(cursoId) {
  const curso = cursosAsignados.find(c => c.id === cursoId);
  if (!curso) return;
  
  const cursoReal = DB.obtenerCurso(curso.id);
  if (!cursoReal) return;
  
  const estudiantes = DB.obtenerEstudiantesCurso(cursoReal.id);
  
  let mensaje = `üìã LISTA DE ESTUDIANTES\n`;
  mensaje += `Curso: ${curso.nombre}\n`;
  mensaje += `C√≥digo: ${curso.codigo}\n`;
  mensaje += `Total: ${estudiantes.length} estudiantes\n\n`;
  
  if (estudiantes.length === 0) {
    mensaje += 'No hay estudiantes inscritos a√∫n.';
  } else {
    estudiantes.forEach((est, idx) => {
      mensaje += `${idx + 1}. ${est.nombre}\n`;
      mensaje += `   C√≥digo: ${est.codigo}\n`;
      mensaje += `   Email: ${est.email}\n\n`;
    });
  }
  
  alert(mensaje);
}


function generarReporteGeneral(tipo) {
  const usuario = obtenerUsuarioActual();
  if (!usuario) return;
  
  const cursos = DB.obtenerCursosProfesor(usuario.id);
  
  let contenido = '';
  let nombreArchivo = '';
  
  switch(tipo) {
    case 'notas':
      contenido = generarReporteNotas(cursos);
      nombreArchivo = 'reporte_notas';
      break;
    case 'asistencia':
      contenido = generarReporteAsistencia(cursos);
      nombreArchivo = 'reporte_asistencia';
      break;
    case 'evaluaciones':
      contenido = generarReporteEvaluaciones(cursos);
      nombreArchivo = 'reporte_evaluaciones';
      break;
    case 'consolidado':
      contenido = generarReporteConsolidado(cursos);
      nombreArchivo = 'reporte_consolidado';
      break;
  }
  
  descargarReporteTexto(contenido, nombreArchivo);
}

function generarReporteNotas(cursos) {
  let reporte = '========================================\n';
  reporte += '     REPORTE DE NOTAS - UNIVERSIDAD DE MEDELL√çN\n';
  reporte += '========================================\n\n';
  reporte += `Profesor: ${obtenerUsuarioActual().nombre}\n`;
  reporte += `Fecha: ${new Date().toLocaleDateString('es-CO')}\n\n`;
  
  cursos.forEach(curso => {
    reporte += `\n--- ${curso.nombre} (${curso.codigo}) ---\n`;
    reporte += `Semestre: ${curso.semestre}\n`;
    reporte += `Estudiantes: ${curso.estudiantes}\n\n`;
    
    const estudiantes = DB.obtenerEstudiantesCurso(curso.id);
    
    if (estudiantes.length === 0) {
      reporte += 'No hay estudiantes inscritos.\n';
    } else {
      reporte += 'ESTUDIANTE                    C√ìDIGO      NOTA FINAL\n';
      reporte += '--------------------------------------------------------\n';
      
      estudiantes.forEach(est => {
        const notaFinal = est.notaFinal ? est.notaFinal.toFixed(2) : 'N/A';
        reporte += `${est.nombre.padEnd(28)} ${est.codigo.padEnd(10)} ${notaFinal}\n`;
      });
    }
    reporte += '\n';
  });
  
  return reporte;
}

function generarReporteAsistencia(cursos) {
  let reporte = '========================================\n';
  reporte += '   REPORTE DE ASISTENCIA - UNIVERSIDAD DE MEDELL√çN\n';
  reporte += '========================================\n\n';
  reporte += `Profesor: ${obtenerUsuarioActual().nombre}\n`;
  reporte += `Fecha: ${new Date().toLocaleDateString('es-CO')}\n\n`;
  
  cursos.forEach(curso => {
    reporte += `\n--- ${curso.nombre} (${curso.codigo}) ---\n`;
    reporte += `Horario: ${curso.horario}\n`;
    reporte += `Aula: ${curso.aula}\n\n`;
    
    const estudiantes = DB.obtenerEstudiantesCurso(curso.id);
    reporte += `Total estudiantes inscritos: ${estudiantes.length}\n`;
    reporte += `Asistencia promedio estimada: ${Math.floor(Math.random() * 20 + 75)}%\n`;
    
    reporte += '\nESTUDIANTE                    C√ìDIGO      ASISTENCIA\n';
    reporte += '--------------------------------------------------------\n';
    
    estudiantes.forEach(est => {
      const asistencia = Math.floor(Math.random() * 30 + 70);
      reporte += `${est.nombre.padEnd(28)} ${est.codigo.padEnd(10)} ${asistencia}%\n`;
    });
    reporte += '\n';
  });
  
  return reporte;
}

function generarReporteEvaluaciones(cursos) {
  let reporte = '========================================\n';
  reporte += ' REPORTE DE EVALUACIONES - UNIVERSIDAD DE MEDELL√çN\n';
  reporte += '========================================\n\n';
  reporte += `Profesor: ${obtenerUsuarioActual().nombre}\n`;
  reporte += `Fecha: ${new Date().toLocaleDateString('es-CO')}\n\n`;
  
  cursos.forEach(curso => {
    reporte += `\n--- ${curso.nombre} (${curso.codigo}) ---\n\n`;
    
    const evaluaciones = DB.obtenerEvaluacionesCurso(curso.id);
    
    if (evaluaciones.length === 0) {
      reporte += 'No hay evaluaciones configuradas.\n';
    } else {
      reporte += 'EVALUACI√ìN                    PORCENTAJE  ESTADO\n';
      reporte += '--------------------------------------------------------\n';
      
      evaluaciones.forEach(ev => {
        const estado = ev.porcentaje > 0 ? 'Configurada' : 'Pendiente';
        reporte += `${ev.nombre.padEnd(28)} ${String(ev.porcentaje + '%').padEnd(10)} ${estado}\n`;
      });
      
      const totalPorcentaje = evaluaciones.reduce((sum, ev) => sum + ev.porcentaje, 0);
      reporte += '\n' + '-'.repeat(56) + '\n';
      reporte += `TOTAL:                        ${totalPorcentaje}%\n`;
    }
    reporte += '\n';
  });
  
  return reporte;
}

function generarReporteConsolidado(cursos) {
  let reporte = '========================================\n';
  reporte += '  REPORTE CONSOLIDADO - UNIVERSIDAD DE MEDELL√çN\n';
  reporte += '========================================\n\n';
  reporte += `Profesor: ${obtenerUsuarioActual().nombre}\n`;
  reporte += `Fecha: ${new Date().toLocaleDateString('es-CO')}\n`;
  reporte += `Cursos asignados: ${cursos.length}\n\n`;
  
  // Resumen general
  let totalEstudiantes = 0;
  cursos.forEach(curso => {
    totalEstudiantes += curso.estudiantes;
  });
  
  reporte += '--- RESUMEN GENERAL ---\n';
  reporte += `Total de estudiantes: ${totalEstudiantes}\n`;
  reporte += `Promedio por curso: ${(totalEstudiantes / cursos.length).toFixed(1)}\n\n`;
  
  // Detalle por curso
  reporte += '--- DETALLE POR CURSO ---\n\n';
  cursos.forEach(curso => {
    const estudiantes = DB.obtenerEstudiantesCurso(curso.id);
    const evaluaciones = DB.obtenerEvaluacionesCurso(curso.id);
    
    reporte += `${curso.nombre} (${curso.codigo})\n`;
    reporte += `  ‚Ä¢ L√≠nea: ${curso.lineaEnfasis}\n`;
    reporte += `  ‚Ä¢ Horario: ${curso.horario}\n`;
    reporte += `  ‚Ä¢ Aula: ${curso.aula}\n`;
    reporte += `  ‚Ä¢ Estudiantes: ${estudiantes.length}\n`;
    reporte += `  ‚Ä¢ Evaluaciones: ${evaluaciones.length}\n`;
    
    if (estudiantes.length > 0) {
      const notasConValor = estudiantes.filter(e => e.notaFinal !== null);
      if (notasConValor.length > 0) {
        const promedioNota = notasConValor.reduce((sum, e) => sum + e.notaFinal, 0) / notasConValor.length;
        reporte += `  ‚Ä¢ Promedio del curso: ${promedioNota.toFixed(2)}\n`;
      }
    }
    reporte += '\n';
  });
  
  return reporte;
}

function descargarReporteTexto(contenido, nombreBase) {
  const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${nombreBase}_${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  if (typeof agregarNotificacion === 'function') {
    agregarNotificacion(`üìÑ Reporte "${nombreBase}" descargado exitosamente`);
  }
}
   // ==================== COORDINADOR ====================

function inicializarDashboardCoordinador() {
  cargarEstadisticasCoordinador();
  cargarSolicitudesPendientes();
  renderLineasAdmin();
}

function cargarEstadisticasCoordinador() {
  const solicitudesPendientes = DB.obtenerTodasSolicitudes({ estado: 'pendiente' });
  const lineas = DB.obtenerLineasEnfasis();
  
  let totalEstudiantes = 0;
  lineas.forEach(linea => {
    totalEstudiantes += (linea.cuposTotales - linea.cuposDisponibles);
  });
  
  // Actualizar SOLO los badges (spans con clases de color)
  const badges = document.querySelectorAll('#dashboard-coordinador .space-y-4 > div > span[class*="bg-"]');
  if (badges.length >= 3) {
    badges[0].textContent = solicitudesPendientes.length;
    badges[1].textContent = lineas.length;
    badges[2].textContent = totalEstudiantes;
  }
}
// Auto-actualizar cuando hay cambios
window.addEventListener('db-updated', () => {
  const usuario = obtenerUsuarioActual();
  if (usuario && usuario.rol === 'coordinador') {
    cargarEstadisticasCoordinador();
    cargarSolicitudesPendientes();
    renderLineasAdmin();
  }
});

function cargarSolicitudesPendientes() {
  const tbody = document.querySelector('#dashboard-coordinador table tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  const solicitudes = DB.obtenerTodasSolicitudes({ estado: 'pendiente' });
  
  if (solicitudes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">No hay solicitudes pendientes</td></tr>';
    return;
  }
  
  solicitudes.forEach(sol => {
    const tr = document.createElement('tr');
    tr.className = 'border-t';
    tr.innerHTML = `
      <td class="p-3">${sol.estudianteNombre}</td>
      <td class="p-3">${sol.lineaNombre}</td>
      <td class="p-3"><span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Pendiente</span></td>
      <td class="p-3">
        <button onclick="verSolicitudDetalle(${sol.id})" class="bg-udem-azul text-white px-3 py-1 rounded text-xs hover:bg-udem-azul-hover">
          Ver Detalles
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function verSolicitudDetalle(solicitudId) {
  const solicitud = DB.obtenerTodasSolicitudes().find(s => s.id === solicitudId);
  if (!solicitud) {
    console.error('Solicitud no encontrada:', solicitudId);
    alert('‚ùå Error: No se pudo cargar la solicitud');
    return;
  }
  
  const modal = document.getElementById('modal-solicitud-detalle');
  const detalle = document.getElementById('detalle-solicitud');
  
  if (!modal || !detalle) {
    console.error('Elementos del modal no encontrados');
    return;
  }
  
  // Validar que archivos existe
  const archivos = solicitud.archivos || {
    notas: 'No adjuntado',
    motivacion: 'No adjuntado',
    prerrequisitos: [],
    otros: []
  };
  
  detalle.innerHTML = `
    <div class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-gray-600">Estudiante</label>
          <p class="font-medium">${solicitud.nombre || 'N/A'}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600">C√≥digo</label>
          <p class="font-medium">${solicitud.codigo || 'N/A'}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600">C√©dula</label>
          <p class="font-medium">${solicitud.cedula || 'N/A'}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600">Email</label>
          <p class="font-medium">${solicitud.email || 'N/A'}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600">Programa</label>
          <p class="font-medium">${solicitud.programa || 'N/A'}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600">Semestre</label>
          <p class="font-medium">${solicitud.semestre || 'N/A'}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600">Promedio</label>
          <p class="font-medium text-blue-600">${solicitud.promedio || 'N/A'}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600">L√≠nea solicitada</label>
          <p class="font-medium text-udem-rojo">${solicitud.lineaNombre || 'N/A'}</p>
        </div>
      </div>
      
      <div class="border-t pt-4">
        <label class="text-sm text-gray-600 block mb-2">üìé Documentos adjuntos</label>
        <ul class="text-sm space-y-1 bg-gray-50 p-3 rounded">
          <li>üìÑ Certificado de notas: <span class="font-medium">${archivos.notas}</span></li>
          <li>üìÑ Carta de motivaci√≥n: <span class="font-medium">${archivos.motivacion}</span></li>
          ${archivos.prerrequisitos && archivos.prerrequisitos.length > 0 ? 
            archivos.prerrequisitos.map(a => `<li>üìÑ Prerrequisito: <span class="font-medium">${a}</span></li>`).join('') : 
            '<li class="text-gray-400 italic">Sin prerrequisitos adjuntos</li>'}
          ${archivos.otros && archivos.otros.length > 0 ? 
            archivos.otros.map(a => `<li>üìÑ Otro: <span class="font-medium">${a}</span></li>`).join('') : 
            '<li class="text-gray-400 italic">Sin otros documentos</li>'}
        </ul>
      </div>
      
      <div class="border-t pt-4">
        <label class="text-sm text-gray-600 block mb-2">üìÖ Fecha de solicitud</label>
        <p class="text-sm font-medium">${new Date(solicitud.fechaSolicitud).toLocaleString('es-CO', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })}</p>
      </div>
      
      ${solicitud.observaciones ? `
        <div class="border-t pt-4">
          <label class="text-sm text-gray-600 block mb-2">üí¨ Observaciones</label>
          <p class="text-sm bg-yellow-50 p-3 rounded">${solicitud.observaciones}</p>
        </div>
      ` : ''}
    </div>
  `;
  
  // Guardar ID en el modal para usarlo despu√©s
  modal.dataset.solicitudId = solicitudId;
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  
  console.log('‚úÖ Modal abierto para solicitud:', solicitudId);
}
function closeSolicitudDetalle() {
  const modal = document.getElementById('modal-solicitud-detalle');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

function aprobarSolicitud() {
  const modal = document.getElementById('modal-solicitud-detalle');
  const solicitudId = parseInt(modal.dataset.solicitudId);
  const usuario = obtenerUsuarioActual();
  
  if (!usuario) {
    alert('‚ùå Error: Debes iniciar sesi√≥n');
    return;
  }
  
  if (!solicitudId || isNaN(solicitudId)) {
    alert('‚ùå Error: ID de solicitud inv√°lido');
    console.error('ID de solicitud inv√°lido:', modal.dataset.solicitudId);
    return;
  }
  
  if (confirm('¬øAprobar esta solicitud? El estudiante ser√° inscrito autom√°ticamente.')) {
    const resultado = DB.aprobarSolicitud(solicitudId, usuario.id);
    if (resultado) {
      closeSolicitudDetalle();
      cargarSolicitudesPendientes();
      cargarEstadisticasCoordinador();
      alert('‚úÖ Solicitud aprobada. El estudiante ha sido notificado.');
    } else {
      alert('‚ùå Error al aprobar la solicitud. Intenta nuevamente.');
    }
  }
}

function rechazarSolicitud() {
  const modal = document.getElementById('modal-solicitud-detalle');
  const solicitudId = parseInt(modal.dataset.solicitudId);
  const usuario = obtenerUsuarioActual();
  
  if (!usuario) {
    alert('‚ùå Error: Debes iniciar sesi√≥n');
    return;
  }
  
  if (!solicitudId || isNaN(solicitudId)) {
    alert('‚ùå Error: ID de solicitud inv√°lido');
    console.error('ID de solicitud inv√°lido:', modal.dataset.solicitudId);
    return;
  }
  
  const motivo = prompt('Motivo del rechazo (opcional):');
  if (motivo === null) return; // Cancel√≥
  
  const resultado = DB.rechazarSolicitud(solicitudId, usuario.id, motivo);
  if (resultado) {
    closeSolicitudDetalle();
    cargarSolicitudesPendientes();
    cargarEstadisticasCoordinador();
    alert('‚ùå Solicitud rechazada. El estudiante ha sido notificado.');
  } else {
    alert('‚ùå Error al rechazar la solicitud. Intenta nuevamente.');
  }
}
// ========== GESTI√ìN DE L√çNEAS DE √âNFASIS ==========

function renderLineasAdmin() {
  const ul = document.getElementById('lista-lineas-admin');
  if (!ul) return;
  
  ul.innerHTML = '';
  const lineas = DB.obtenerLineasEnfasis();
  
  if (lineas.length === 0) {
    ul.innerHTML = '<li class="text-gray-500 text-sm">No hay l√≠neas creadas. Usa el formulario arriba para crear una.</li>';
    return;
  }
  
  lineas.forEach(linea => {
    const li = document.createElement('li');
    li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded border';
    li.innerHTML = `
      <div class="flex-1">
        <div class="font-medium text-gray-800">${linea.nombre}</div>
        <div class="text-sm text-gray-600">
          ${linea.programa} ‚Ä¢ ${linea.codigo} ‚Ä¢ Cupos: ${linea.cuposDisponibles}/${linea.cuposTotales}
        </div>
        <div class="text-xs text-gray-500 mt-1">
          Profesor: ${linea.profesorNombre} ‚Ä¢ ${linea.modalidad} ‚Ä¢ ${linea.horario}
        </div>
      </div>
      <div class="space-x-2">
        <button onclick="verDetalleLineaCoord(${linea.id})" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
          üëÅÔ∏è Ver
        </button>
        <button onclick="editarLineaCoord(${linea.id})" class="bg-yellow-500 text-white px-3 py-1 rounded text-xs hover:bg-yellow-600">
          ‚úèÔ∏è Editar
        </button>
        <button onclick="eliminarLineaCoord(${linea.id})" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">
          üóëÔ∏è
        </button>
      </div>
    `;
    ul.appendChild(li);
  });
}

function agregarLinea(e) {
  e.preventDefault();
  openModalCrearLinea();
}

function openModalCrearLinea() {
  // Crear modal din√°mico
  const modalHTML = `
    <div id="modal-crear-linea" class="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/60" onclick="closeModalCrearLinea()"></div>
      <div class="relative bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6 z-10">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Crear Nueva L√≠nea de √ânfasis</h3>
          <button onclick="closeModalCrearLinea()" class="text-gray-400 hover:text-gray-600 text-xl">‚úï</button>
        </div>
        
        <form id="form-crear-linea" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la L√≠nea *</label>
              <input type="text" id="linea-nombre" required class="w-full border rounded px-3 py-2" placeholder="ej: Seguridad Inform√°tica">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo *</label>
              <input type="text" id="linea-codigo" required class="w-full border rounded px-3 py-2" placeholder="ej: LE-SI-001">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Programa *</label>
              <select id="linea-programa" required class="w-full border rounded px-3 py-2">
                <option value="">Seleccionar...</option>
                <option value="Ingenier√≠a de Sistemas">Ingenier√≠a de Sistemas</option>
                <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                <option value="Matem√°ticas">Matem√°ticas</option>
                <option value="Dise√±o Gr√°fico">Dise√±o Gr√°fico</option>
                <option value="Administraci√≥n">Administraci√≥n</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Modalidad *</label>
              <select id="linea-modalidad" required class="w-full border rounded px-3 py-2">
                <option value="presencial">Presencial</option>
                <option value="virtual">Virtual</option>
                <option value="hibrida">H√≠brida</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cupos Totales *</label>
              <input type="number" id="linea-cupos" required min="1" max="100" class="w-full border rounded px-3 py-2" value="25">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cr√©ditos *</label>
              <input type="number" id="linea-creditos" required min="1" max="20" class="w-full border rounded px-3 py-2" value="6">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Horario *</label>
              <input type="text" id="linea-horario" required class="w-full border rounded px-3 py-2" placeholder="ej: Lun-Mi√© 2:00-4:00 PM">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Aula/Sala *</label>
              <input type="text" id="linea-aula" required class="w-full border rounded px-3 py-2" placeholder="ej: Lab 302">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio *</label>
              <input type="date" id="linea-fecha" required class="w-full border rounded px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Profesor Asignado *</label>
              <select id="linea-profesor" required class="w-full border rounded px-3 py-2">
                <option value="">Seleccionar...</option>
              </select>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
            <textarea id="linea-descripcion" rows="3" class="w-full border rounded px-3 py-2" placeholder="Descripci√≥n de la l√≠nea de √©nfasis..."></textarea>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Prerrequisitos</label>
            <input type="text" id="linea-prerrequisitos" class="w-full border rounded px-3 py-2" placeholder="ej: Redes de Computadores, Promedio m√≠nimo: 3.5">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Competencias</label>
            <input type="text" id="linea-competencias" class="w-full border rounded px-3 py-2" placeholder="ej: An√°lisis de vulnerabilidades, Implementaci√≥n de controles">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Herramientas</label>
            <input type="text" id="linea-herramientas" class="w-full border rounded px-3 py-2" placeholder="ej: Kali Linux, Wireshark, Metasploit">
          </div>
          
          <div class="flex justify-end gap-3 pt-4 border-t">
            <button type="button" onclick="closeModalCrearLinea()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">
              Cancelar
            </button>
            <button type="submit" class="px-6 py-2 bg-udem-rojo text-white rounded-lg hover:bg-udem-rojo-hover font-semibold">
              ‚úÖ Crear L√≠nea
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Cargar profesores en el select
  const profesores = DB.obtenerProfesores();
  const selectProf = document.getElementById('linea-profesor');
  profesores.forEach(prof => {
    const option = document.createElement('option');
    option.value = prof.id;
    option.textContent = prof.nombre;
    selectProf.appendChild(option);
  });
  
  // Evento submit
  document.getElementById('form-crear-linea').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const datos = {
      nombre: document.getElementById('linea-nombre').value,
      codigo: document.getElementById('linea-codigo').value,
      programa: document.getElementById('linea-programa').value,
      modalidad: document.getElementById('linea-modalidad').value,
      cuposTotales: document.getElementById('linea-cupos').value,
      creditos: document.getElementById('linea-creditos').value,
      horario: document.getElementById('linea-horario').value,
      aula: document.getElementById('linea-aula').value,
      fechaInicio: document.getElementById('linea-fecha').value,
      profesorId: document.getElementById('linea-profesor').value,
      descripcion: document.getElementById('linea-descripcion').value,
      prerrequisitos: document.getElementById('linea-prerrequisitos').value,
      competencias: document.getElementById('linea-competencias').value,
      herramientas: document.getElementById('linea-herramientas').value
    };
    
    DB.crearLineaEnfasis(datos);
    closeModalCrearLinea();
    renderLineasAdmin();
    cargarEstadisticasCoordinador();
    alert('‚úÖ L√≠nea de √©nfasis creada exitosamente');
  });
}

function closeModalCrearLinea() {
  const modal = document.getElementById('modal-crear-linea');
  if (modal) modal.remove();
}

function verDetalleLineaCoord(lineaId) {
  const linea = DB.obtenerLineaEnfasis(lineaId);
  if (!linea) return;
  
  alert(`üìã DETALLES DE LA L√çNEA\n\n` +
        `Nombre: ${linea.nombre}\n` +
        `C√≥digo: ${linea.codigo}\n` +
        `Programa: ${linea.programa}\n` +
        `Cupos: ${linea.cuposDisponibles}/${linea.cuposTotales}\n` +
        `Modalidad: ${linea.modalidad}\n` +
        `Horario: ${linea.horario}\n` +
        `Aula: ${linea.aula}\n` +
        `Profesor: ${linea.profesorNombre}\n\n` +
        `Descripci√≥n: ${linea.descripcion || 'N/A'}`);
}

function editarLineaCoord(lineaId) {
  const linea = DB.obtenerLineaEnfasis(lineaId);
  if (!linea) return;
  
  // Crear modal de edici√≥n
  const modalHTML = `
    <div id="modal-editar-linea" class="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/60" onclick="closeModalEditarLinea()"></div>
      <div class="relative bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6 z-10">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Editar L√≠nea de √ânfasis</h3>
          <button onclick="closeModalEditarLinea()" class="text-gray-400 hover:text-gray-600 text-xl">‚úï</button>
        </div>
        
        <form id="form-editar-linea" class="space-y-4">
          <input type="hidden" id="edit-linea-id" value="${linea.id}">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la L√≠nea *</label>
              <input type="text" id="edit-linea-nombre" required class="w-full border rounded px-3 py-2" value="${linea.nombre}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo *</label>
              <input type="text" id="edit-linea-codigo" required class="w-full border rounded px-3 py-2" value="${linea.codigo}" readonly>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Programa *</label>
              <select id="edit-linea-programa" required class="w-full border rounded px-3 py-2">
                <option value="Ingenier√≠a de Sistemas" ${linea.programa === 'Ingenier√≠a de Sistemas' ? 'selected' : ''}>Ingenier√≠a de Sistemas</option>
                <option value="Ingenier√≠a Industrial" ${linea.programa === 'Ingenier√≠a Industrial' ? 'selected' : ''}>Ingenier√≠a Industrial</option>
                <option value="Matem√°ticas" ${linea.programa === 'Matem√°ticas' ? 'selected' : ''}>Matem√°ticas</option>
                <option value="Dise√±o Gr√°fico" ${linea.programa === 'Dise√±o Gr√°fico' ? 'selected' : ''}>Dise√±o Gr√°fico</option>
                <option value="Administraci√≥n" ${linea.programa === 'Administraci√≥n' ? 'selected' : ''}>Administraci√≥n</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Modalidad *</label>
              <select id="edit-linea-modalidad" required class="w-full border rounded px-3 py-2">
                <option value="presencial" ${linea.modalidad === 'presencial' ? 'selected' : ''}>Presencial</option>
                <option value="virtual" ${linea.modalidad === 'virtual' ? 'selected' : ''}>Virtual</option>
                <option value="hibrida" ${linea.modalidad === 'hibrida' ? 'selected' : ''}>H√≠brida</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cupos Totales *</label>
              <input type="number" id="edit-linea-cupos" required min="1" max="100" class="w-full border rounded px-3 py-2" value="${linea.cuposTotales}">
              <p class="text-xs text-gray-500 mt-1">Cupos disponibles actuales: ${linea.cuposDisponibles}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cr√©ditos *</label>
              <input type="number" id="edit-linea-creditos" required min="1" max="20" class="w-full border rounded px-3 py-2" value="${linea.creditos}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Horario *</label>
              <input type="text" id="edit-linea-horario" required class="w-full border rounded px-3 py-2" value="${linea.horario}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Aula/Sala *</label>
              <input type="text" id="edit-linea-aula" required class="w-full border rounded px-3 py-2" value="${linea.aula}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio *</label>
              <input type="date" id="edit-linea-fecha" required class="w-full border rounded px-3 py-2" value="${linea.fechaInicio.split('T')[0]}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Profesor Asignado *</label>
              <select id="edit-linea-profesor" required class="w-full border rounded px-3 py-2">
                <option value="">Seleccionar...</option>
              </select>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
            <textarea id="edit-linea-descripcion" rows="3" class="w-full border rounded px-3 py-2">${linea.descripcion || ''}</textarea>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Prerrequisitos</label>
            <input type="text" id="edit-linea-prerrequisitos" class="w-full border rounded px-3 py-2" value="${linea.prerrequisitos || ''}">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Competencias</label>
            <input type="text" id="edit-linea-competencias" class="w-full border rounded px-3 py-2" value="${linea.competencias || ''}">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Herramientas</label>
            <input type="text" id="edit-linea-herramientas" class="w-full border rounded px-3 py-2" value="${linea.herramientas || ''}">
          </div>
          
          <div class="flex justify-end gap-3 pt-4 border-t">
            <button type="button" onclick="closeModalEditarLinea()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">
              Cancelar
            </button>
            <button type="submit" class="px-6 py-2 bg-udem-rojo text-white rounded-lg hover:bg-udem-rojo-hover font-semibold">
              üíæ Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Cargar profesores
  const profesores = DB.obtenerProfesores();
  const selectProf = document.getElementById('edit-linea-profesor');
  profesores.forEach(prof => {
    const option = document.createElement('option');
    option.value = prof.id;
    option.textContent = prof.nombre;
    option.selected = prof.id === linea.profesorId;
    selectProf.appendChild(option);
  });
  
  // Evento submit
  document.getElementById('form-editar-linea').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const lineaId = parseInt(document.getElementById('edit-linea-id').value);
    const datos = {
      nombre: document.getElementById('edit-linea-nombre').value,
      programa: document.getElementById('edit-linea-programa').value,
      modalidad: document.getElementById('edit-linea-modalidad').value,
      cuposTotales: parseInt(document.getElementById('edit-linea-cupos').value),
      creditos: parseInt(document.getElementById('edit-linea-creditos').value),
      horario: document.getElementById('edit-linea-horario').value,
      aula: document.getElementById('edit-linea-aula').value,
      fechaInicio: document.getElementById('edit-linea-fecha').value,
      profesorId: parseInt(document.getElementById('edit-linea-profesor').value),
      descripcion: document.getElementById('edit-linea-descripcion').value,
      prerrequisitos: document.getElementById('edit-linea-prerrequisitos').value,
      competencias: document.getElementById('edit-linea-competencias').value,
      herramientas: document.getElementById('edit-linea-herramientas').value
    };
    
    await DB.actualizarLineaEnfasis(lineaId, datos);
    closeModalEditarLinea();
    renderLineasAdmin();
    cargarEstadisticasCoordinador();
    alert('‚úÖ L√≠nea de √©nfasis actualizada exitosamente');
  });
}

function closeModalEditarLinea() {
  const modal = document.getElementById('modal-editar-linea');
  if (modal) modal.remove();
}

function eliminarLineaCoord(lineaId) {
  if (confirm('¬øEliminar esta l√≠nea de √©nfasis? Esta acci√≥n no se puede deshacer.')) {
    DB.eliminarLineaEnfasis(lineaId);
    renderLineasAdmin();
    cargarEstadisticasCoordinador();
    alert('üóëÔ∏è L√≠nea eliminada');
  }
}
// ==================== ASISTENTE VIRTUAL - FUNCIONES GLOBALES ====================

function abrirChat() {
  console.log('üü¢ Abriendo chat...');
  const chatWindow = document.getElementById('chat-window');
  if (chatWindow) {
    chatWindow.classList.remove('hidden');
    document.getElementById('chat-input').focus();
  } else {
    console.error('‚ùå No se encontr√≥ chat-window');
  }
}

function cerrarChat() {
  console.log('üî¥ Cerrando chat...');
  const chatWindow = document.getElementById('chat-window');
  if (chatWindow) {
    chatWindow.classList.add('hidden');
  }
}

function enviarMensaje() {
  const input = document.getElementById('chat-input');
  const chatBody = document.getElementById('chat-body');
  
  if (!input || !chatBody) {
    console.error('‚ùå No se encontraron elementos');
    return;
  }
  
  const texto = input.value.trim();
  if (!texto) return;
  
  console.log('üì§ Enviando:', texto);
  
  // Agregar mensaje del usuario
  const msgUser = document.createElement('div');
  msgUser.className = 'chat-message user-message';
  msgUser.innerHTML = `<p>${texto}</p>`;
  chatBody.appendChild(msgUser);
  
  input.value = '';
  chatBody.scrollTop = chatBody.scrollHeight;
  
  // Mostrar "escribiendo..."
  const typing = document.createElement('div');
  typing.className = 'chat-message assistant-message';
  typing.innerHTML = '<p>Escribiendo...</p>';
  chatBody.appendChild(typing);
  chatBody.scrollTop = chatBody.scrollHeight;
  
  // Responder despu√©s de 800ms
  setTimeout(() => {
    typing.remove();
    
    const respuesta = obtenerRespuestaChat(texto);
    const msgBot = document.createElement('div');
    msgBot.className = 'chat-message assistant-message';
    msgBot.innerHTML = `<p>${respuesta}</p>`;
    chatBody.appendChild(msgBot);
    chatBody.scrollTop = chatBody.scrollHeight;
  }, 800);
}

function obtenerRespuestaChat(pregunta) {
  const p = pregunta.toLowerCase();
  
  // Verificar si DB est√° lista
  if (!window.DB || !window.DB.ready) {
    return '‚è≥ Un momento, estoy cargando la informaci√≥n de las l√≠neas...';
  }
  
  const lineas = window.DB.obtenerLineasEnfasis();
  
  // SALUDOS
  if (p.match(/hola|buenos|buenas|hey/)) {
    return `¬°Hola! üëã Soy tu asistente.<br><br>Puedo ayudarte con:<br>üìö Ver l√≠neas<br>üìä Consultar cupos<br>üéØ Recomendaciones<br><br>Prueba: <b>"¬øqu√© l√≠neas hay?"</b>`;
  }
  
  // DESPEDIDAS
  if (p.match(/gracias|adios|chao/)) {
    return '¬°De nada! üòä Aqu√≠ estar√© si necesitas algo m√°s.';
  }
  
  // AYUDA
  if (p.match(/ayuda|help/)) {
    return `ü§ñ <b>Puedo responder:</b><br><br>"¬øQu√© l√≠neas hay?"<br>"Cupos de seguridad"<br>"Recomienda para sistemas"<br>"Horario de IA"<br><br>¬°Prueba cualquiera!`;
  }
  
  // LISTAR L√çNEAS
  if (p.match(/l√≠neas|lineas|hay|disponibles|cuales/)) {
    if (lineas.length === 0) {
      return '‚ö†Ô∏è No hay l√≠neas disponibles en este momento.';
    }
    
    let resp = `üìö <b>${lineas.length} l√≠neas disponibles:</b><br><br>`;
    lineas.forEach((l, i) => {
      const icono = l.cuposDisponibles > 5 ? '‚úÖ' : l.cuposDisponibles > 0 ? '‚ö†Ô∏è' : '‚ùå';
      resp += `${i+1}. <b>${l.nombre}</b> ${icono}<br>`;
      resp += `&nbsp;&nbsp;&nbsp;${l.programa}<br>`;
      resp += `&nbsp;&nbsp;&nbsp;Cupos: ${l.cuposDisponibles}/${l.cuposTotales}<br><br>`;
    });
    return resp;
  }
  
  // CUPOS
  if (p.match(/cupo|cu√°ntos|disponible/)) {
    const linea = buscarLineaChat(p, lineas);
    if (linea) {
      const estado = linea.cuposDisponibles === 0 ? '‚ùå Lleno' : 
                     linea.cuposDisponibles < 5 ? '‚ö†Ô∏è √öltimos cupos' : '‚úÖ Disponible';
      return `üìä <b>${linea.nombre}</b><br><br>Cupos: <b>${linea.cuposDisponibles}</b> de ${linea.cuposTotales}<br>Estado: ${estado}`;
    }
    return 'No encontr√© esa l√≠nea. Escribe <b>"l√≠neas"</b> para ver todas.';
  }
  
  // RECOMENDACIONES
  if (p.match(/recomienda|sugiere|para/)) {
    let programa = null;
    if (p.includes('sistema')) programa = 'Ingenier√≠a de Sistemas';
    if (p.includes('industrial')) programa = 'Ingenier√≠a Industrial';
    if (p.includes('matem√°tica')) programa = 'Matem√°ticas';
    
    if (programa) {
      const lineasProg = lineas.filter(l => l.programa === programa);
      if (lineasProg.length === 0) {
        return `üòî No hay l√≠neas para <b>${programa}</b>.`;
      }
      
      let resp = `üéØ <b>Para ${programa}:</b><br><br>`;
      lineasProg.forEach(l => {
        resp += `‚Ä¢ <b>${l.nombre}</b><br>`;
        resp += `&nbsp;&nbsp;Cupos: ${l.cuposDisponibles}/${l.cuposTotales}<br>`;
        resp += `&nbsp;&nbsp;${l.modalidad}<br><br>`;
      });
      return resp;
    }
    return '¬øPara qu√© programa? Ej: <b>"recomienda para sistemas"</b>';
  }
  
  // HORARIO
  if (p.match(/horario|cu√°ndo|hora/)) {
    const linea = buscarLineaChat(p, lineas);
    if (linea) {
      return `üïê <b>${linea.nombre}</b><br><br>Horario: <b>${linea.horario}</b><br>Modalidad: ${linea.modalidad}<br>Aula: ${linea.aula}`;
    }
    return '¬øDe qu√© l√≠nea quieres saber el horario?';
  }
  
  // RESPUESTA POR DEFECTO
  return `ü§î No entend√≠. Intenta:<br><br>"¬øQu√© l√≠neas hay?"<br>"Cupos de seguridad"<br>"Recomienda para sistemas"<br><br>O escribe <b>"ayuda"</b>`;
}

function buscarLineaChat(texto, lineas) {
  const t = texto.toLowerCase();
  
  // Buscar por nombre
  for (const linea of lineas) {
    if (t.includes(linea.nombre.toLowerCase())) {
      return linea;
    }
  }
  
  // Buscar por keywords
  if (t.includes('seguridad')) return lineas.find(l => l.nombre.includes('Seguridad'));
  if (t.includes('inteligencia') || t.includes('ia')) return lineas.find(l => l.nombre.includes('Inteligencia'));
  if (t.includes('calidad')) return lineas.find(l => l.nombre.includes('Calidad'));
  if (t.includes('datos')) return lineas.find(l => l.nombre.includes('Datos'));
  
  return null;
}

// Auto-recargar datos cuando la pesta√±a vuelve a estar activa
document.addEventListener('visibilitychange', async () => {
  if (!document.hidden && DB.ready) {
    console.log('üîÑ Pesta√±a activa, sincronizando datos...');
    await DB.cargarDatos();
    window.dispatchEvent(new CustomEvent('db-updated'));
  }
});

// Mostrar indicador cuando se sincronizan datos
window.addEventListener('db-updated', () => {
  const indicator = document.createElement('div');
  indicator.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2';
  indicator.innerHTML = 'üîÑ <span>Datos sincronizados</span>';
  document.body.appendChild(indicator);
  
  setTimeout(() => {
    indicator.style.transition = 'opacity 0.5s';
    indicator.style.opacity = '0';
    setTimeout(() => indicator.remove(), 500);
  }, 2000);
});

// Funci√≥n auxiliar para detectar conflictos de horario
function hayConflictoHorario(horario1, horario2) {
  const dias1 = horario1.toLowerCase();
  const dias2 = horario2.toLowerCase();
  const diasComunes = ['lun', 'mar', 'mie', 'jue', 'vie', 'sab', 'dom'];
  return diasComunes.some(dia => dias1.includes(dia) && dias2.includes(dia));
}
</script>
<!-- ==================== ASISTENTE VIRTUAL SIMPLIFICADO ==================== -->
<div id="chat-widget" class="fixed bottom-6 right-6 z-50">
  <!-- BOT√ìN FLOTANTE -->
  <button onclick="abrirChat()" 
          id="open-chat-btn"
          title="Asistente Virtual" 
          class="bg-udem-rojo text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center hover:bg-udem-rojo-hover transition-all transform hover:scale-110">
    <span class="text-3xl">ü§ñ</span>
  </button>

  <!-- VENTANA DEL CHAT -->
  <div id="chat-window" 
       class="hidden fixed bottom-24 right-6 w-96 bg-white rounded-2xl shadow-2xl border">
    
    <!-- HEADER -->
    <div class="bg-gradient-to-r from-udem-rojo to-red-700 text-white p-4 rounded-t-2xl flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
          <span class="text-2xl">ü§ñ</span>
        </div>
        <div>
          <h3 class="font-bold text-lg">Asistente UdeM</h3>
          <p class="text-xs text-white/80">En l√≠nea</p>
        </div>
      </div>
      <button onclick="cerrarChat()" 
              class="text-white/70 hover:text-white text-2xl">
        ‚úï
      </button>
    </div>

    <!-- CUERPO DEL CHAT -->
    <div id="chat-body" 
         class="p-4 h-96 overflow-y-auto bg-gray-50">
      <!-- MENSAJE INICIAL -->
      <div class="chat-message assistant-message">
        <p><b>üëã ¬°Hola!</b></p>
        <p>Soy tu asistente de la UdeM.</p>
        <br>
        <p><b>Preg√∫ntame sobre:</b></p>
        <p>üìö L√≠neas disponibles</p>
        <p>üìä Cupos</p>
        <p>üéØ Recomendaciones</p>
        <br>
        <p><i>Escribe "ayuda" para m√°s opciones</i></p>
      </div>
    </div>

    <!-- INPUT -->
    <div class="p-4 border-t bg-white rounded-b-2xl">
      <div class="flex items-center gap-2">
        <input type="text" 
               id="chat-input" 
               placeholder="Escribe aqu√≠..." 
               onkeypress="if(event.key==='Enter') enviarMensaje()"
               class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-udem-azul focus:outline-none text-sm">
        <button onclick="enviarMensaje()" 
                class="bg-udem-rojo text-white px-4 py-2 rounded-lg hover:bg-udem-rojo-hover font-bold">
          ‚û§
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .chat-message {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 16px;
    margin-bottom: 12px;
    line-height: 1.5;
    font-size: 14px;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .assistant-message {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    color: #1f2937;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .user-message {
    background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
    color: white;
    border-bottom-right-radius: 4px;
    margin-left: auto;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
</style>
  </div>
</body>
</html>